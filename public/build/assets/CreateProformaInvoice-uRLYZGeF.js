import{e as xe,u as je,b as ye,r as p,j as e,C as _e}from"./index-D77JVx93.js";import{a as C,b as n,c as k}from"./index.esm-CnYARBHd.js";import{p as fe}from"./api-C2dAnRUz.js";import{C as K,a as Y}from"./CCardBody-CmpV1lA4.js";import{C as Ce}from"./cil-mobile-CeKkmNgt.js";import{C as y}from"./CButton-1GsZ7-l4.js";import{C as be}from"./CCardHeader-CTLciU6o.js";import{c as ve}from"./cil-arrow-left-D66Kb3Zq.js";import{C as ke}from"./CForm-CvVYu-wE.js";import{C as m}from"./CFormLabel-Dc8HuNh9.js";import{C as i}from"./CFormInput-l8xIFq1a.js";import{C as x}from"./CInputGroup-iSurCesp.js";import{C as b}from"./CInputGroupText-BPolkdL-.js";import{C as Z}from"./DefaultLayout-B9m2Op0L.js";import{c as ee}from"./cil-pencil-m516yCOw.js";import{c as te}from"./cil-x-0440B5Ce.js";import{C as Se}from"./CFormTextarea-BeYCqixl.js";import{c as Pe}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-Bm4xoNnJ.js";import"./RawMaterial-BtjEDAbB.js";const He=()=>{var H,X,J;const se=xe(),T=je(),{showToast:S}=ye(),{workOrderId:L,workOrderData:h}=se.state||{},[D,z]=p.useState(!1),[re,ne]=p.useState(!1);p.useState([]);const[ae,we]=p.useState([]),[a,F]=p.useState({work_order_id:L||null,project_id:(h==null?void 0:h.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[_,N]=p.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:"",gst_percent:18,cgst_amount:0,sgst_amount:0}]),oe=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[P,q]=p.useState(oe),[ce,G]=p.useState(-1),[M,V]=p.useState(""),[I,B]=p.useState(""),le=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[w,W]=p.useState(le),[ie,E]=p.useState(-1),[$,Q]=p.useState(""),[O,U]=p.useState("");p.useState(""),p.useEffect(()=>{if(h&&(F(s=>({...s,work_order_id:h.id,project_id:h.project_id})),h.items&&h.items.length>0)){const s=h.items.map(t=>({work_type:t.work_type||"",uom:t.uom||"",qty:t.qty||0,price:t.price||0,total_price:t.total_price||0,remark:t.remark||"",gst_percent:t.gst_percent||18,cgst_amount:t.cgst_amount||0,sgst_amount:t.sgst_amount||0}));N(s),R(s)}},[h]);const f=s=>{const{name:t,value:r}=s.target;F(c=>{let u={...c,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(r)||0:r};if(t==="gstPercentage"){const l=(parseFloat(r)||0)/2;u={...u,sgstPercentage:l,cgstPercentage:l}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const j=t==="sgstPercentage"?parseFloat(r)||0:c.sgstPercentage,l=t==="cgstPercentage"?parseFloat(r)||0:c.cgstPercentage;u={...u,gstPercentage:j+l}}if(t==="discount"||t.endsWith("Percentage")){const j=_.reduce((pe,he)=>pe+(he.total_price||0),0),l=j-u.discount,g=l*(u.sgstPercentage/100),o=l*(u.cgstPercentage/100),d=l*(u.igstPercentage/100),A=g+o+d,ge=l+A;u={...u,subtotal:j,taxableAmount:l,gstAmount:A,sgstAmount:g,cgstAmount:o,igstAmount:d,finalAmount:ge}}return u})},v=(s,t,r)=>{const c=[..._];t==="qty"||t==="price"||t==="gst_percent"?c[s][t]=parseFloat(r)||0:c[s][t]=r;const u=c[s].qty||0,j=c[s].price||0,l=c[s].gst_percent||0,g=u*j,o=g*(l/2/100),d=g*(l/2/100),A=g+o+d;c[s].total_price=A,c[s].cgst_amount=o,c[s].sgst_amount=d,N(c),R(c)},de=()=>{N([..._,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:0,sgst_amount:0,remark:""}])},me=s=>{const t=[..._];t.splice(s,1),N(t),R(t)},R=s=>{F(t=>{const r=s.reduce((g,o)=>g+o.qty*o.price,0),c=s.reduce((g,o)=>g+(o.cgst_amount||0),0),u=s.reduce((g,o)=>g+(o.sgst_amount||0),0),j=c+u,l=s.reduce((g,o)=>g+(o.total_price||0),0);return{...t,subtotal:r,taxableAmount:r,gstAmount:j,cgstAmount:c,sgstAmount:u,igstAmount:0,finalAmount:l-(t.discount||0)}})},ue=async s=>{var r,c,u,j;if(s.preventDefault(),!s.currentTarget.checkValidity()){ne(!0);return}if(!a.work_order_id||!a.project_id){S("danger","Work order and project information missing");return}if(_.length===0||_.every(l=>!l.work_type||l.qty<=0)){S("danger","Please add at least one valid work item");return}try{z(!0);const l=_.filter(d=>d.work_type&&d.qty>0).map(d=>({work_type:d.work_type,uom:d.uom||null,qty:parseFloat(d.qty)||0,price:parseFloat(d.price)||0,total_price:parseFloat(d.total_price)||0,remark:d.remark||null,gst_percent:parseFloat(d.gst_percent)||18,cgst_amount:parseFloat(d.cgst_amount)||0,sgst_amount:parseFloat(d.sgst_amount)||0})),g={work_order_id:a.work_order_id,project_id:a.project_id,tally_invoice_number:a.tally_invoice_number||null,invoice_date:a.invoice_date,delivery_date:a.delivery_date||null,items:l,discount:a.discount,gst_percentage:a.gstPercentage,cgst_percentage:a.cgstPercentage,sgst_percentage:a.sgstPercentage,igst_percentage:a.igstPercentage,rule_ids:ae,notes:a.notes||null,payment_terms:P.join(`
`),terms_conditions:w.join(`
`)},o=await fe("/api/proforma-invoices",g);if(o&&o.success)S("success","Proforma invoice created successfully"),setTimeout(()=>{T(`/proforma-invoice-details/${o.data.id}`)},1500);else throw new Error(o.message||"Failed to create proforma invoice")}catch(l){console.error("Submit error:",l);const g=((c=(r=l.response)==null?void 0:r.data)==null?void 0:c.message)||"Failed to create proforma invoice",o=(j=(u=l.response)==null?void 0:u.data)==null?void 0:j.data;if(o&&o.work_order_total!==void 0){const d=`

Work Order Total: ₹${o.work_order_total.toLocaleString()}
Already Allocated: ₹${o.already_allocated.toLocaleString()}
Remaining: ₹${o.remaining_amount.toLocaleString()}
Requested: ₹${o.requested_amount.toLocaleString()}`;S("danger",g+d,8e3)}else S("danger",g)}finally{z(!1)}};return!L||!h?e.jsx(K,{children:e.jsx(Y,{children:e.jsxs(Ce,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(y,{color:"primary",onClick:()=>T("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(C,{children:e.jsx(n,{xs:12,children:e.jsxs(K,{className:"mb-4",children:[e.jsx(be,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(y,{color:"secondary",size:"sm",onClick:()=>T("/invoiceTable"),children:[e.jsx(k,{icon:ve,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(Y,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(C,{children:[e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:h.invoice_number})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(H=h.project)==null?void 0:H.project_name})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(X=h.project)==null?void 0:X.customer_name})})]}),e.jsxs(n,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(J=h.project)==null?void 0:J.work_place})]})]})]}),e.jsxs(ke,{validated:re,onSubmit:ue,children:[e.jsxs(C,{className:"mb-3",children:[e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Tally Invoice Number"}),e.jsx(i,{type:"text",name:"tally_invoice_number",value:a.tally_invoice_number,onChange:f,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Invoice Date *"}),e.jsx(i,{type:"date",name:"invoice_date",value:a.invoice_date,onChange:f,required:!0})]}),e.jsxs(n,{md:4,children:[e.jsx(m,{children:"Delivery Date"}),e.jsx(i,{type:"date",name:"delivery_date",value:a.delivery_date,onChange:f})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),_.map((s,t)=>e.jsxs(C,{className:"g-3 mb-3 align-items-end",children:[e.jsxs(n,{md:2,children:[e.jsx(m,{children:"Work Type *"}),e.jsx(i,{placeholder:"Work Type",value:s.work_type,onChange:r=>v(t,"work_type",r.target.value),required:!0})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"UOM"}),e.jsx(i,{placeholder:"Unit",value:s.uom,onChange:r=>v(t,"uom",r.target.value)})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"Qty"}),e.jsx(i,{type:"number",placeholder:"Qty",step:"0.01",min:"0",value:s.qty,onChange:r=>v(t,"qty",r.target.value),required:!0})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"Rate"}),e.jsxs(x,{children:[e.jsx(b,{children:"₹"}),e.jsx(i,{type:"number",step:"0.01",min:"0",value:s.price,onChange:r=>v(t,"price",r.target.value),required:!0})]})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"Base Amt"}),e.jsxs("div",{className:"fw-medium",children:["₹",(s.qty*s.price).toFixed(2)]})]}),e.jsx(n,{md:1,children:e.jsx(i,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:s.gst_percent,onChange:r=>v(t,"gst_percent",r.target.value)})}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",s.cgst_amount]})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",s.sgst_amount]})]}),e.jsxs(n,{md:1,children:[e.jsx(m,{className:"text-primary",children:"Total"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",s.total_price]})]}),e.jsx(n,{md:1,children:e.jsx(i,{placeholder:"Remark",value:s.remark,onChange:r=>v(t,"remark",r.target.value)})}),e.jsx(n,{md:1,className:"d-flex align-items-end",children:e.jsx(y,{color:"danger",size:"sm",className:"w-100",onClick:()=>me(t),disabled:_.length===1,children:"×"})})]},t)),e.jsx(y,{color:"warning",variant:"outline",className:"mb-4",onClick:de,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Total GST (%)"}),e.jsxs(x,{children:[e.jsx(i,{type:"number",name:"gstPercentage",value:a.gstPercentage,onChange:f,min:"0",max:"100",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.gstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"SGST (%)"}),e.jsxs(x,{children:[e.jsx(i,{type:"number",name:"sgstPercentage",value:a.sgstPercentage,onChange:f,min:"0",max:"50",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.sgstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"CGST (%)"}),e.jsxs(x,{children:[e.jsx(i,{type:"number",name:"cgstPercentage",value:a.cgstPercentage,onChange:f,min:"0",max:"50",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.cgstAmount]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"IGST (%)"}),e.jsxs(x,{children:[e.jsx(i,{type:"number",name:"igstPercentage",value:a.igstPercentage,onChange:f,min:"0",max:"100",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",a.igstAmount]})]})]}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Subtotal"}),e.jsxs(x,{children:[e.jsx(b,{children:"₹"}),e.jsx(i,{type:"number",value:a.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Discount"}),e.jsxs(x,{children:[e.jsx(b,{children:"₹"}),e.jsx(i,{type:"number",name:"discount",value:a.discount,onChange:f,min:"0",step:"0.01"})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Taxable Amount"}),e.jsxs(x,{children:[e.jsx(b,{children:"₹"}),e.jsx(i,{type:"number",value:a.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(n,{md:3,children:[e.jsx(m,{children:"Final Amount"}),e.jsxs(x,{children:[e.jsx(b,{children:"₹"}),e.jsx(i,{type:"number",value:a.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:P.map((s,t)=>ce===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(i,{value:M,onChange:r=>V(r.target.value)}),e.jsx(y,{color:"success",onClick:()=>{const r=[...P];r[t]=M,q(r),G(-1)},children:"Save"}),e.jsx(y,{color:"secondary",onClick:()=>G(-1),children:"Cancel"})]},t):e.jsxs(Z,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(k,{icon:ee,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{G(t),V(s)}}),e.jsx(k,{icon:te,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{q(P.filter((r,c)=>c!==t))}})]},t))}),e.jsx(C,{className:"mb-3",children:e.jsx(n,{md:6,children:e.jsxs(x,{children:[e.jsx(i,{placeholder:"Add new payment term...",value:I,onChange:s=>B(s.target.value)}),e.jsx(y,{color:"primary",onClick:()=>{I.trim()&&(q([...P,I.trim()]),B(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:w.map((s,t)=>ie===t?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(i,{value:$,onChange:r=>Q(r.target.value)}),e.jsx(y,{color:"success",onClick:()=>{const r=[...w];r[t]=$,W(r),E(-1)},children:"Save"}),e.jsx(y,{color:"secondary",onClick:()=>E(-1),children:"Cancel"})]},t):e.jsxs(Z,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(k,{icon:ee,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{E(t),Q(s)}}),e.jsx(k,{icon:te,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{W(w.filter((r,c)=>c!==t))}})]},t))}),e.jsx(C,{className:"mb-3",children:e.jsx(n,{md:6,children:e.jsxs(x,{children:[e.jsx(i,{placeholder:"Add new condition...",value:O,onChange:s=>U(s.target.value)}),e.jsx(y,{color:"primary",onClick:()=>{O.trim()&&(W([...w,O.trim()]),U(""))},children:"Add"})]})})}),e.jsx(C,{className:"mb-3",children:e.jsxs(n,{md:12,children:[e.jsx(m,{children:"Additional Notes"}),e.jsx(Se,{name:"notes",value:a.notes,onChange:f,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(y,{color:"primary",type:"submit",disabled:D,children:[D?e.jsx(_e,{size:"sm"}):e.jsx(k,{icon:Pe,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{He as default};
