const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./jspdf.es.min-BwCsaKCZ.js","./index-C2h9iXsq.js","./index-BznZZSPc.css","./typeof-QjJsDpFa.js","./jspdf.plugin.autotable-BqrGn1St.js","./jspdf.es.min-B0tN83gG.js"])))=>i.map(i=>d[i]);
import{b as X,r as i,j as e,C as G,o as Z}from"./index-C2h9iXsq.js";import{S as ae}from"./react-select.esm-BTZ6xrLn.js";import{f as he,a as W,b as pe}from"./api-C2dAnRUz.js";import{a as R,b as h,c as re}from"./index.esm-DQbyd5df.js";import{P as xe}from"./ProjectSelectionModal-B4H1mPqU.js";import{C as ne}from"./CForm-BVvPNiqY.js";import{C as p}from"./CFormLabel-DkkhltaS.js";import{C as g}from"./CFormInput-Da28fgYD.js";import{C as v}from"./CButton--W_4ZeJh.js";import{c as je}from"./cil-search-CDkY_4k-.js";import{c as ge}from"./cil-x-0440B5Ce.js";import{e as oe,a as ie,b as le,c as ce,d as be}from"./DefaultLayout-Bb3k2Kjc.js";import{C as _e,a as fe}from"./CCardBody-DHWC5_BS.js";import{C as ye}from"./CCardHeader-BOYr8GAh.js";import{C as Ce,a as ve,b as se,c as N,d as Se,e as F}from"./CTable-B2fFA3gN.js";import{C as we}from"./cil-mobile-CRjBRZgk.js";import"./defineProperty-DJACW-dl.js";import"./typeof-QjJsDpFa.js";import"./emotion-react.browser.esm-CYwH7O3b.js";import"./floating-ui.dom-ByRZgDQ1.js";import"./CFormControlWrapper-CgtL4Ts4.js";import"./RawMaterial-BtjEDAbB.js";const Pe=({vendors:D,onSuccess:u,onCancel:M})=>{const{showToast:x}=X(),[O,b]=i.useState({name:"",id:null}),[f,y]=i.useState([]),[o,A]=i.useState(!1),[m,V]=i.useState(!1),[n,S]=i.useState({project_id:"",vendor_id:"",material_name:"",about:"",price_per_unit:0,qty:1,total:0,date:new Date().toISOString().split("T")[0]}),U=(s,c)=>Number((s*c).toFixed(2)),l=s=>{const{name:c,value:P}=s.target;S(E=>{const k={...E,[c]:P};if(c==="qty"||c==="price_per_unit"){const Y=c==="qty"?parseFloat(P)||0:parseFloat(E.qty)||0,J=c==="price_per_unit"?parseFloat(P)||0:parseFloat(E.price_per_unit)||0;k.total=U(Y,J)}return k})},T=async s=>{if(!s.trim()){y([]);return}try{const c=await W(`/api/projects?searchQuery=${s}`);y(c||[])}catch{x("danger","Error searching projects")}},q=s=>{const c=s.target.value;b({name:c,id:null}),T(c)},w=s=>{b({name:s.project_name,id:s.id}),S(c=>({...c,project_id:s.id})),y([])},$=async s=>{var P,E;if(s.preventDefault(),!n.project_id)return x("danger","Please select a project");if(!n.vendor_id)return x("danger","Please select a vendor");if(!n.material_name.trim())return x("danger","Enter material name");if(n.price_per_unit<=0)return x("danger","Price must be > 0");if(n.qty<=0)return x("danger","Quantity must be > 0");const c={project_id:parseInt(n.project_id),vendor_id:parseInt(n.vendor_id),material_name:n.material_name,about:n.about||null,price_per_unit:parseFloat(n.price_per_unit),qty:parseFloat(n.qty),total:parseFloat(n.total),date:n.date,paid_amount:0};V(!0);try{await he("/api/purchesVendor",c),x("success","Purchase saved successfully!"),u()}catch(k){x("danger",((E=(P=k.response)==null?void 0:P.data)==null?void 0:E.message)||k.message)}finally{V(!1)}},L=()=>{S({project_id:"",vendor_id:"",material_name:"",about:"",price_per_unit:0,qty:1,total:0,date:new Date().toISOString().split("T")[0]}),b({name:"",id:null}),y([])};return e.jsxs(e.Fragment,{children:[e.jsx("style",{jsx:!0,global:!0,children:`
        .suggestions-list {
          position: absolute;
          z-index: 1050;
          background: white;
          border: 1px solid #ddd;
          border-radius: 0.375rem;
          max-height: 200px;
          overflow-y: auto;
          width: 100%;
          margin-top: 4px;
          padding: 0;
          list-style: none;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .suggestions-list li {
          padding: 10px 12px;
          cursor: pointer;
          border-bottom: 1px solid #eee;
          transition: background 0.2s;
        }
        .suggestions-list li:hover {
          background: #f1f3f5;
        }
        .form-control:focus {
          border-color: #80bdff;
          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .total-input {
          background-color: #f8f9fa !important;
          font-weight: 600;
          color: #2c3e50;
        }
      `}),e.jsxs(ne,{onSubmit:$,className:"needs-validation p-4 border ",children:[e.jsxs(R,{className:"g-4 align-items-end",children:[e.jsxs(h,{md:4,style:{position:"relative"},children:[e.jsxs(p,{className:"fw-bold",children:["Project Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("div",{style:{position:"relative"},children:[e.jsx(g,{type:"text",placeholder:"Search project...",value:O.name,onChange:q,autoComplete:"off",required:!0,className:"pe-5"}),O.id?e.jsx(v,{color:"danger",variant:"outline",size:"sm",onClick:()=>{b({name:"",id:null}),S(s=>({...s,project_id:""})),y([])},style:{position:"absolute",right:2,top:2,bottom:2,borderRadius:"0.375rem",width:"36px"},className:"d-flex align-items-center justify-content-center",children:e.jsx(re,{icon:ge,size:"sm"})}):e.jsx(v,{color:"primary",variant:"outline",size:"sm",onClick:()=>A(!0),style:{position:"absolute",right:2,top:2,bottom:2,borderRadius:"0.375rem",width:"36px"},className:"d-flex align-items-center justify-content-center",children:e.jsx(re,{icon:je,size:"sm"})})]}),f.length>0&&e.jsx("ul",{className:"suggestions-list",children:f.map(s=>e.jsx("li",{onClick:()=>w(s),children:s.project_name},s.id))})]}),e.jsxs(h,{md:4,children:[e.jsxs(p,{className:"fw-bold",children:["Vendor ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsxs("select",{className:"form-select",name:"vendor_id",value:n.vendor_id,onChange:l,required:!0,children:[e.jsx("option",{value:"",children:"Select Vendor"}),D.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs(h,{md:4,children:[e.jsxs(p,{className:"fw-bold",children:["Material Name ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(g,{type:"text",name:"material_name",placeholder:"e.g. Cement, Sand",value:n.material_name,onChange:l,required:!0})]})]}),e.jsx(R,{className:"g-4 mt-3",children:e.jsxs(h,{md:12,children:[e.jsx(p,{className:"fw-bold",children:"About (optional)"}),e.jsx(g,{type:"text",name:"about",placeholder:"Enter description...",value:n.about,onChange:l})]})}),e.jsxs(R,{className:"g-4 mt-3 align-items-end",children:[e.jsxs(h,{md:3,children:[e.jsxs(p,{className:"fw-bold",children:["Price/Unit ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(g,{type:"number",name:"price_per_unit",value:n.price_per_unit,onChange:l,min:"0",step:"0.01",required:!0})]}),e.jsxs(h,{md:3,children:[e.jsxs(p,{className:"fw-bold",children:["Quantity ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(g,{type:"number",name:"qty",value:n.qty,onChange:l,min:"0.01",step:"0.01",required:!0})]}),e.jsxs(h,{md:3,children:[e.jsx(p,{className:"fw-bold",children:"Total"}),e.jsx(g,{type:"number",value:n.total,readOnly:!0,className:"total-input"})]}),e.jsxs(h,{md:3,children:[e.jsxs(p,{className:"fw-bold",children:["Date ",e.jsx("span",{className:"text-danger",children:"*"})]}),e.jsx(g,{type:"date",name:"date",value:n.date,onChange:l,max:new Date().toISOString().split("T")[0],required:!0})]})]}),e.jsxs(oe,{className:"border-0 pt-4 justify-content-between",children:[e.jsxs("div",{children:[e.jsx(v,{color:"secondary",onClick:L,className:"me-2",children:"Clear"}),e.jsx(v,{color:"secondary",onClick:M,children:"Cancel"})]}),e.jsx(v,{color:"success",type:"submit",disabled:m,children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{size:"sm",className:"me-2"}),"Saving..."]}):"Submit Purchase"})]})]}),e.jsx(xe,{visible:o,onClose:()=>A(!1),onSelectProject:w})]})},Ne=({visible:D,purchase:u,vendors:M,onClose:x,onSuccess:O})=>{var n,S,U;const{showToast:b}=X(),[f,y]=i.useState(!1),[o,A]=i.useState({payment_id:u.id,vendor_id:((n=u.vendor_id)==null?void 0:n.toString())||"",project_id:((S=u.project_id)==null?void 0:S.toString())||"",project_name:((U=u.project)==null?void 0:U.project_name)||"—",material_name:u.material_name||"",about:u.about||"",price_per_unit:parseFloat(u.price_per_unit)||0,qty:parseFloat(u.qty)||1,date:u.date||""}),m=l=>{const{name:T,value:q}=l.target;A(w=>({...w,[T]:q}))},V=async()=>{var T,q;if(!o.material_name.trim())return b("danger","Material name is required");if(o.price_per_unit<=0)return b("danger","Price must be > 0");if(o.qty<=0)return b("danger","Quantity must be > 0");const l={payment_id:parseInt(o.payment_id),vendor_id:parseInt(o.vendor_id),project_id:parseInt(o.project_id),material_name:o.material_name,about:o.about||null,price_per_unit:parseFloat(o.price_per_unit),qty:parseFloat(o.qty),date:o.date};y(!0);try{await pe("/api/updatePurchesVendorPayment",l),b("success","Purchase updated successfully!"),O(),x()}catch(w){b("danger","Update failed: "+(((q=(T=w.response)==null?void 0:T.data)==null?void 0:q.message)||w.message))}finally{y(!1)}};return e.jsxs(ie,{visible:D,onClose:x,backdrop:"static",size:"lg",children:[e.jsx(le,{closeButton:!0,children:e.jsx(ce,{children:"Edit Purchase"})}),e.jsx(be,{children:e.jsxs(ne,{children:[e.jsxs(R,{className:"g-3",children:[e.jsxs(h,{md:6,children:[e.jsx(p,{children:e.jsx("b",{children:"Project"})}),e.jsx(g,{type:"text",value:o.project_name,readOnly:!0,plaintext:!0})]}),e.jsxs(h,{md:6,children:[e.jsx(p,{children:e.jsx("b",{children:"Vendor *"})}),e.jsxs("select",{className:"form-select",name:"vendor_id",value:o.vendor_id,onChange:m,required:!0,children:[e.jsx("option",{value:"",children:"Select Vendor"}),M.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]})]})]}),e.jsx(R,{className:"g-3 mt-3",children:e.jsxs(h,{md:12,children:[e.jsx(p,{children:e.jsx("b",{children:"Material Name *"})}),e.jsx(g,{type:"text",name:"material_name",value:o.material_name,onChange:m,required:!0})]})}),e.jsx(R,{className:"g-3 mt-3",children:e.jsxs(h,{md:12,children:[e.jsx(p,{children:e.jsx("b",{children:"About (optional)"})}),e.jsx(g,{type:"text",name:"about",placeholder:"Description...",value:o.about,onChange:m})]})}),e.jsxs(R,{className:"g-3 mt-3 align-items-end",children:[e.jsxs(h,{md:4,children:[e.jsx(p,{children:e.jsx("b",{children:"Price/Unit *"})}),e.jsx(g,{type:"number",name:"price_per_unit",value:o.price_per_unit,onChange:m,min:"0",step:"0.01",required:!0})]}),e.jsxs(h,{md:4,children:[e.jsx(p,{children:e.jsx("b",{children:"Quantity *"})}),e.jsx(g,{type:"number",name:"qty",value:o.qty,onChange:m,min:"0.01",step:"0.01",required:!0})]}),e.jsxs(h,{md:4,children:[e.jsx(p,{children:e.jsx("b",{children:"Date *"})}),e.jsx(g,{type:"date",name:"date",value:o.date,onChange:m,max:new Date().toISOString().split("T")[0],required:!0})]})]})]})}),e.jsxs(oe,{children:[e.jsx(v,{color:"secondary",onClick:x,children:"Cancel"}),e.jsx(v,{color:"primary",onClick:V,disabled:f,children:f?e.jsx(G,{size:"sm"}):"Update"})]})]})},Je=()=>{const[D,u]=i.useState([]),[M,x]=i.useState([]),[O,b]=i.useState([]),[f,y]=i.useState(!1),[o,A]=i.useState(!1),[m,V]=i.useState(!0),[n,S]=i.useState(null),[U,l]=i.useState(!1),[T,q]=i.useState(!1),[w,$]=i.useState(null),{showToast:L}=X(),[s,c]=i.useState(null),[P,E]=i.useState(null),k=i.useRef(null),Y=async()=>{try{const t=await W("/api/getPurchesVendor");x(t||[])}catch{L("danger","Error loading vendors")}},J=async()=>{try{const t=await W("/api/projects");b(t||[])}catch{L("danger","Failed to load projects")}},K=async(t=null,r=!1)=>{try{r?A(!0):y(!0);const j=t?`/api/purchesVendor?cursor=${t}&perPage=10`:"/api/purchesVendor?perPage=10",_=await W(j),I=(_==null?void 0:_.data)||[];u(r?z=>[...z,...I]:I),S(_.next_cursor),V(_.has_more_pages)}catch{L("danger","Failed to load purchases"),r||u([])}finally{y(!1),A(!1)}};i.useEffect(()=>{Y(),J(),K()},[]);const ee=i.useCallback(()=>{!o&&!f&&m&&n&&K(n,!0)},[o,f,m,n]);i.useEffect(()=>{const t=new IntersectionObserver(j=>{j[0].isIntersecting&&m&&!o&&!f&&ee()},{threshold:.1,rootMargin:"100px"}),r=k.current;return r&&t.observe(r),()=>{r&&t.unobserve(r)}},[m,o,f,ee]);const te=()=>{u([]),S(null),V(!0),K()},de=t=>{$(t),q(!0)},C=D.filter(t=>{const r=s?t.project_id===s.value:!0,j=P?t.vendor_id===P.value:!0;return r&&j}),ue=()=>{Z(()=>import("./jspdf.es.min-BwCsaKCZ.js").then(t=>t.j),__vite__mapDeps([0,1,2,3]),import.meta.url).then(t=>{Z(()=>import("./jspdf.plugin.autotable-BqrGn1St.js").then(r=>r.j),__vite__mapDeps([4,1,2,5,0,3]),import.meta.url).then(()=>{const r=new t.jsPDF("landscape");r.setFont("helvetica","bold"),r.setFontSize(18),r.text("PURCHASE REPORT",14,15),r.setFontSize(11),r.setFont("helvetica","normal"),r.text(`Generated On: ${new Date().toLocaleDateString()}`,14,25),r.setFontSize(12),r.setFont("helvetica","bold"),r.text(`Total Records: ${C.length}`,14,33);const j=C.reduce((a,d)=>a+Number(d.qty||0),0),_=C.reduce((a,d)=>a+Number(d.total||0),0),I=C.reduce((a,d)=>a+Number(d.price_per_unit||0),0),z=["Sr No","Project","Vendor","Material","Price/Unit","Qty","Total","Date","About"],Q=[];C.forEach((a,d)=>{var B,H;Q.push([d+1,((B=a.project)==null?void 0:B.project_name)||"—",((H=a.vendor)==null?void 0:H.name)||"—",a.material_name,parseFloat(a.price_per_unit).toFixed(2),a.qty,parseFloat(a.total).toFixed(2),new Date(a.date).toLocaleDateString(),a.about||"—"])}),Q.push([{content:"Total:",colSpan:4,styles:{halign:"right",fontStyle:"bold"}},I.toFixed(2),j,_.toFixed(2),"",""]),r.autoTable({head:[z],body:Q,startY:45,theme:"grid",headStyles:{fillColor:[30,115,120],textColor:255,fontSize:10,halign:"center"},bodyStyles:{fontSize:9,halign:"center"},styles:{lineWidth:.25,lineColor:[120,120,120]},alternateRowStyles:{fillColor:[245,245,245]},didDrawPage:a=>{const d=r.internal.pageSize.height;r.setFontSize(10),r.setTextColor(100),r.text(`Purchase Report | Generated: ${new Date().toLocaleDateString()}`,a.settings.margin.left,d-10),r.text(`Page ${r.internal.getNumberOfPages()}`,r.internal.pageSize.width-30,d-10)}}),r.save("purchase_report.pdf")})})},me=()=>{Z(()=>import("./xlsx-B6sNpj_1.js"),[],import.meta.url).then(t=>{const r=C.reduce((a,d)=>a+Number(d.qty||0),0),j=C.reduce((a,d)=>a+Number(d.total||0),0),_=C.reduce((a,d)=>a+Number(d.price_per_unit||0),0),I=C.map((a,d)=>{var B,H;return{"Sr No":d+1,Project:((B=a.project)==null?void 0:B.project_name)||"—",Vendor:((H=a.vendor)==null?void 0:H.name)||"—",Material:a.material_name,"Price/Unit":parseFloat(a.price_per_unit).toFixed(2),Qty:a.qty,Total:parseFloat(a.total).toFixed(2),Date:new Date(a.date).toLocaleDateString(),About:a.about||"—"}});I.push({"Sr No":"",Project:"",Vendor:"",Material:"Total:","Price/Unit":_.toFixed(2),Qty:r,Total:j.toFixed(2),Date:"",About:""});const z=t.utils.json_to_sheet(I);Object.keys(z).forEach(a=>{(a.startsWith("A1")||a.startsWith("B1")||a.startsWith("C1"))&&(z[a].s={font:{bold:!0}})});const Q=t.utils.book_new();t.utils.book_append_sheet(Q,z,"Purchases"),t.writeFile(Q,"purchase_report.xlsx")})};return e.jsxs(e.Fragment,{children:[e.jsxs(_e,{className:"mb-4",children:[e.jsxs(ye,{className:"d-flex justify-content-between align-items-center flex-wrap gap-3",style:{paddingBottom:"1rem"},children:[e.jsx("strong",{children:"Purchase History"}),e.jsxs("div",{className:"d-flex align-items-center gap-3 flex-wrap",children:[e.jsx(v,{color:"primary",onClick:ue,children:"Download PDF"}),e.jsx(v,{color:"info",onClick:me,children:"Download Excel"}),e.jsx("div",{style:{width:200},children:e.jsx(ae,{placeholder:"Filter by Project",options:O.map(t=>({value:t.id,label:t.project_name})),value:s,onChange:c,isClearable:!0})}),e.jsx("div",{style:{width:200},children:e.jsx(ae,{placeholder:"Filter by Vendor",options:M.map(t=>({value:t.id,label:t.name})),value:P,onChange:E,isClearable:!0})}),e.jsx(v,{color:"success",onClick:()=>l(!0),children:"Add Purchase"})]})]}),e.jsx(fe,{children:f&&D.length===0?e.jsx("div",{className:"text-center py-4",children:e.jsx(G,{})}):C.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-responsive",children:e.jsxs(Ce,{striped:!0,hover:!0,bordered:!0,children:[e.jsx(ve,{color:"light",children:e.jsxs(se,{children:[e.jsx(N,{children:"Sr. No."}),e.jsx(N,{children:"Project"}),e.jsx(N,{children:"Vendor"}),e.jsx(N,{children:"Material"}),e.jsx(N,{children:"Price/Unit"}),e.jsx(N,{children:"Qty"}),e.jsx(N,{children:"Total"}),e.jsx(N,{children:"Date"}),e.jsx(N,{children:"About"}),e.jsx(N,{children:"Action"})]})}),e.jsx(Se,{children:C.map((t,r)=>{var j,_;return e.jsxs(se,{children:[e.jsx(F,{children:r+1}),e.jsx(F,{children:((j=t.project)==null?void 0:j.project_name)||"—"}),e.jsx(F,{children:((_=t.vendor)==null?void 0:_.name)||"—"}),e.jsx(F,{children:t.material_name}),e.jsxs(F,{children:["₹",parseFloat(t.price_per_unit).toFixed(2)]}),e.jsx(F,{children:t.qty}),e.jsx(F,{children:e.jsxs("strong",{children:["₹",parseFloat(t.total).toFixed(2)]})}),e.jsx(F,{children:new Date(t.date).toLocaleDateString()}),e.jsx(F,{children:t.about||"—"}),e.jsx(F,{children:e.jsx(v,{color:"warning",size:"sm",onClick:()=>de(t),children:"Edit"})})]},t.id)})})]})}),e.jsxs("div",{ref:k,style:{height:"20px",margin:"20px 0"},children:[o&&e.jsxs("div",{className:"text-center",children:[e.jsx(G,{size:"sm",className:"me-2"}),e.jsx("span",{className:"text-muted small",children:"Loading more purchases..."})]}),!m&&D.length>0&&e.jsxs("div",{className:"text-center text-muted small",children:[e.jsx("hr",{}),e.jsxs("p",{children:["All ",D.length," purchases loaded"]})]})]})]}):e.jsx(we,{color:"info",className:"text-center",children:"No matching purchases found."})})]}),e.jsxs(ie,{size:"xl",visible:U,onClose:()=>l(!1),backdrop:"static",children:[e.jsx(le,{closeButton:!0,children:e.jsx(ce,{children:"Add New Purchase"})}),e.jsx(Pe,{vendors:M,onSuccess:()=>{l(!1),te()},onCancel:()=>l(!1)})]}),w&&e.jsx(Ne,{visible:T,purchase:w,vendors:M,onClose:()=>{q(!1),$(null)},onSuccess:te})]})};export{Je as default};
