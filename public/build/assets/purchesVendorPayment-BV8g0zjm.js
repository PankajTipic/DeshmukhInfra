import{r as p,j as e,C as ie,b as Ke}from"./index-C2h9iXsq.js";import{a as z,b as v,c as B}from"./index.esm-DQbyd5df.js";import{h as Qe,a as O,c as Xe,b as Je,p as et}from"./api-C2dAnRUz.js";import{P as tt}from"./ProjectSelectionModal-B4H1mPqU.js";import{r as at,p as rt}from"./Feilds-BHjWXeSc.js";import{a as H,b as Z,c as Y,d as K,f as st,g as ge,h as _e,i as nt,j as be,e as Q,C as ne,n as it}from"./DefaultLayout-Bb3k2Kjc.js";import{C as we}from"./CForm-BVvPNiqY.js";import{C}from"./CFormLabel-DkkhltaS.js";import{C as ve}from"./CFormSelect-ukCskt8P.js";import{C as $}from"./CFormInput-Da28fgYD.js";import{C as le}from"./cil-mobile-CRjBRZgk.js";import{C as g}from"./CButton--W_4ZeJh.js";import{c as Ce}from"./cil-file-CeQgYs_D.js";import{C as Se,a as Pe}from"./CCardBody-DHWC5_BS.js";import{C as Ne}from"./CCardHeader-BOYr8GAh.js";import{C as Te,a as ke,b as X,c as N,d as De,e as T}from"./CTable-B2fFA3gN.js";import{E as oe}from"./jspdf.es.min-BwCsaKCZ.js";import"./jspdf.plugin.autotable-BqrGn1St.js";import{utils as A,writeFile as ce}from"./xlsx-B6sNpj_1.js";import{C as lt}from"./CInputGroup-DQyo9You.js";import{c as ot}from"./cil-search-CDkY_4k-.js";import{c as ct}from"./cil-x-0440B5Ce.js";import{c as dt}from"./cil-pencil-m516yCOw.js";import{c as Fe}from"./cil-plus-D8mtC-W5.js";import"./RawMaterial-BtjEDAbB.js";import"./CFormControlWrapper-CgtL4Ts4.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-B0tN83gG.js";var mt=["512 512","<rect width='264' height='32' x='208' y='80' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M40,96a64,64,0,1,0,64-64A64.072,64.072,0,0,0,40,96Zm64-32A32,32,0,1,1,72,96,32.036,32.036,0,0,1,104,64Z' class='ci-primary'/><rect width='264' height='32' x='208' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,320a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,320Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,224Z' class='ci-primary'/><rect width='264' height='32' x='208' y='400' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,480a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,480Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,384Z' class='ci-primary'/>"],Ae=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M16,64V456H496V64ZM464,424H48V96H464Z' class='ci-primary'/><rect width='88' height='32' x='88' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/>"];const ht=({visible:r,onClose:l,payForm:a={},payError:c,payLoading:n,onChange:d,onSubmit:x,selectedVendorPayment:o})=>{var h,u;const[m,y]=p.useState("upload"),_=()=>{if(!a.payment_file)return null;const i=a.payment_file,j=i.type.startsWith("image/"),f=i.type==="application/pdf";return e.jsxs("div",{className:"mt-3 p-3 border rounded bg-light",children:[e.jsx("strong",{children:"Selected file:"})," ",i.name," (",(i.size/1024).toFixed(2)," KB)",j&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:URL.createObjectURL(i),alt:"Preview",style:{maxWidth:"100%",maxHeight:"200px",objectFit:"contain"}})}),f&&e.jsx("div",{className:"mt-2 text-primary",children:e.jsx("strong",{children:"PDF file selected"})})]})};return e.jsxs(H,{visible:r,onClose:l,backdrop:"static",size:"lg",children:[e.jsx(Z,{onClose:l,children:e.jsx(Y,{children:"Make Payment"})}),e.jsx(K,{children:e.jsxs(we,{children:[e.jsxs(z,{className:"g-3 mb-3",children:[e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Vendor Name"}),e.jsx("div",{className:"form-control bg-light",children:((u=(h=o==null?void 0:o.purchase)==null?void 0:h.vendor)==null?void 0:u.name)||"—"})]}),e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Remaining Balance"}),e.jsxs("div",{className:"form-control text-danger fw-bold",children:["₹",parseFloat((o==null?void 0:o.balance_amount)||0).toFixed(2)]})]})]}),e.jsxs(z,{className:"g-3 mb-3",children:[e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Paid By *"}),e.jsxs(ve,{name:"paid_by",value:a.paid_by||"",onChange:d,children:[e.jsx("option",{value:"",children:"Select Paid By"}),at.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))]})]}),e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Payment Type *"}),e.jsxs(ve,{name:"payment_type",value:a.payment_type||"",onChange:d,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),rt.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))]})]})]}),e.jsxs(z,{className:"g-3 mb-3",children:[e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Amount *"}),e.jsx($,{type:"number",name:"amount",value:a.amount||"",onChange:d,step:"0.01",min:"0.01",placeholder:"0.00"})]}),e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Payment Date *"}),e.jsx($,{type:"date",name:"payment_date",value:a.payment_date||"",onChange:d,max:new Date().toISOString().split("T")[0]})]})]}),e.jsx(z,{className:"mb-3",children:e.jsxs(v,{children:[e.jsx(C,{children:"Description (optional)"}),e.jsx($,{name:"description",value:a.description||"",onChange:d,placeholder:"e.g. Payment for material delivery"})]})}),e.jsxs(st,{variant:"pills",className:"mb-3",children:[e.jsx(ge,{children:e.jsx(_e,{active:m==="upload",onClick:()=>y("upload"),style:{cursor:"pointer"},children:"Upload Photo / File"})}),e.jsx(ge,{children:e.jsx(_e,{active:m==="remark",onClick:()=>y("remark"),style:{cursor:"pointer"},children:"Remark"})})]}),e.jsxs(nt,{children:[e.jsxs(be,{visible:m==="upload",children:[e.jsx(C,{children:"Upload Photo / File (optional)"}),e.jsx($,{type:"file",name:"payment_file",accept:"image/png,image/jpeg,image/jpg,application/pdf",onChange:d}),_()]}),e.jsxs(be,{visible:m==="remark",children:[e.jsx(C,{children:"Remark (optional)"}),e.jsx("textarea",{className:"form-control",name:"remark",rows:"4",value:a.remark||"",onChange:d,placeholder:"Enter any remark..."})]})]}),c&&e.jsx(le,{color:"danger",className:"mt-3",children:c})]})}),e.jsxs(Q,{children:[e.jsx(g,{color:"secondary",onClick:l,children:"Cancel"}),e.jsx(g,{color:"primary",onClick:()=>x(m),disabled:n,children:n?e.jsx(ie,{size:"sm"}):"Submit Payment"})]})]})},pt=({visible:r,onClose:l,isEdit:a=!1,form:c={},vendors:n=[],onChange:d,onSubmit:x,error:o})=>!c||!n?null:e.jsxs(H,{visible:r,onClose:l,size:"lg",backdrop:"static",children:[e.jsx(Z,{onClose:l,children:e.jsxs(Y,{children:[a?"Edit":"Add"," Material"]})}),e.jsx(K,{children:e.jsxs(we,{children:[e.jsxs(z,{className:"g-3",children:[e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Vendor *"}),e.jsxs("select",{className:"form-select",name:"vendor_id",value:c.vendor_id||"",onChange:d,children:[e.jsx("option",{value:"",children:"Select Vendor"}),n.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})]}),e.jsxs(v,{md:6,children:[e.jsx(C,{children:"Material Name *"}),e.jsx($,{name:"material_name",value:c.material_name||"",onChange:d,placeholder:"e.g. Cement, Bricks"})]})]}),e.jsx(z,{className:"g-3 mt-3",children:e.jsxs(v,{children:[e.jsx(C,{children:"About (optional)"}),e.jsx($,{name:"about",value:c.about||"",onChange:d,placeholder:"Any additional details"})]})}),e.jsxs(z,{className:"g-3 mt-3 align-items-end",children:[e.jsxs(v,{md:3,children:[e.jsx(C,{children:"Qty *"}),e.jsx($,{type:"number",name:"qty",value:c.qty||"",onChange:d,min:"0.01",step:"0.01"})]}),e.jsxs(v,{md:3,children:[e.jsx(C,{children:"Price/Unit *"}),e.jsx($,{type:"number",name:"price",value:c.price||"",onChange:d,min:"0",step:"0.01"})]}),e.jsxs(v,{md:3,children:[e.jsx(C,{children:"Total"}),e.jsx($,{value:c.qty&&c.price?(c.qty*c.price).toFixed(2):"0.00",readOnly:!0,className:"bg-light"})]}),e.jsxs(v,{md:3,children:[e.jsx(C,{children:"Date *"}),e.jsx($,{type:"date",name:"date",value:c.date||"",onChange:d,max:new Date().toISOString().split("T")[0]})]})]}),o&&e.jsx(le,{color:"danger",className:"mt-3",children:o})]})}),e.jsxs(Q,{children:[e.jsx(g,{color:"secondary",onClick:l,children:"Cancel"}),e.jsx(g,{color:"primary",onClick:x,children:a?"Update":"Save"})]})]}),ut=({visible:r,onClose:l,logsData:a,loading:c,onDownloadPDF:n,onDownloadExcel:d})=>{var m,y,_,h,u;const[x,o]=p.useState(null);return e.jsxs(e.Fragment,{children:[e.jsxs(H,{visible:r,onClose:l,size:"xl",backdrop:"static",children:[e.jsx(Z,{onClose:l,children:e.jsx(Y,{children:"Payment Logs"})}),e.jsx(K,{children:c?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(ie,{}),e.jsx("p",{children:"Loading..."})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-end gap-2 mb-3",children:[e.jsxs(g,{color:"primary",onClick:n,children:[e.jsx(B,{icon:Ce})," PDF"]}),e.jsxs(g,{color:"success",onClick:d,children:[e.jsx(B,{icon:Ae})," Excel"]})]}),e.jsxs(Se,{className:"mb-4",children:[e.jsx(Ne,{children:"Summary"}),e.jsx(Pe,{children:e.jsxs(z,{children:[e.jsxs(v,{children:[e.jsx("strong",{children:"Vendor:"})," ",(m=a.vendor_details)==null?void 0:m.vendor_name]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Total:"})," ₹",parseFloat(((y=a.payment_master)==null?void 0:y.total_amount)||0).toFixed(2)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Paid:"})," ₹",parseFloat(((_=a.payment_master)==null?void 0:_.paid_amount)||0).toFixed(2)]}),e.jsxs(v,{children:[e.jsx("strong",{children:"Balance:"})," ₹",parseFloat(((h=a.payment_master)==null?void 0:h.balance_amount)||0).toFixed(2)]})]})})]}),e.jsxs(Te,{striped:!0,bordered:!0,hover:!0,children:[e.jsx(ke,{color:"dark",children:e.jsxs(X,{children:[e.jsx(N,{children:"#"}),e.jsx(N,{children:"Paid By"}),e.jsx(N,{children:"Type"}),e.jsx(N,{children:"Amount"}),e.jsx(N,{children:"Date"}),e.jsx(N,{children:"Description"}),e.jsx(N,{children:"File"})]})}),e.jsx(De,{children:(u=a.payment_logs)==null?void 0:u.map((i,j)=>e.jsxs(X,{children:[e.jsx(T,{children:j+1}),e.jsx(T,{children:i.paid_by}),e.jsx(T,{children:e.jsx(ne,{color:i.payment_type==="Cash"?"success":"info",children:i.payment_type})}),e.jsxs(T,{children:["₹",parseFloat(i.amount).toFixed(2)]}),e.jsx(T,{children:new Date(i.payment_date).toLocaleDateString()}),e.jsx(T,{children:i.description||"—"}),e.jsx(T,{children:i.payment_file?e.jsx(g,{size:"sm",color:"info",onClick:()=>o(i.payment_file),children:"View"}):e.jsx(ne,{color:"secondary",children:"No File"})})]},i.id))})]})]}):e.jsx(le,{color:"info",children:"No payment logs found."})}),e.jsx(Q,{children:e.jsx(g,{color:"secondary",onClick:l,children:"Close"})})]}),e.jsxs(H,{visible:!!x,onClose:()=>o(null),size:"lg",children:[e.jsx(Z,{children:e.jsx(Y,{children:"View File"})}),e.jsx(K,{children:x?(()=>{const i=x.split("/").pop(),j=x.startsWith("img/")?x:"img/"+x,f=Qe+j,L=i.split(".").pop().toLowerCase();return L==="pdf"?e.jsx("iframe",{src:f,title:"PDF Preview",style:{width:"100%",height:"70vh",border:"none"}}):["jpg","jpeg","png"].includes(L)?e.jsx("img",{src:f,alt:"File",style:{maxWidth:"100%",maxHeight:"70vh",display:"block",margin:"auto",borderRadius:"10px"}}):e.jsx("p",{style:{color:"red",textAlign:"center"},children:"Unsupported file type"})})():e.jsx("p",{style:{color:"red",textAlign:"center"},children:"File not available"})}),e.jsx(Q,{children:e.jsx(g,{color:"secondary",onClick:()=>o(null),children:"Close"})})]})]})},xt=(r,l)=>{const a=new oe;a.setFontSize(22).setFont(void 0,"bold").text("Purchase Vendor Payments Report",14,20),a.setFontSize(14).setFont(void 0,"normal").text(`Project: ${l}`,14,32),a.setFontSize(12).text(`Generated on: ${new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}`,14,42);const c=["Vendor Name","Total","Paid","Balance","Status","Created"],n=[];let d=0,x=0,o=0;r.forEach(m=>{var j,f;const y=parseFloat(m.amount),_=parseFloat(m.paid_amount),h=parseFloat(m.balance_amount),u=_/y,i=u===0?"Unpaid":u===1?"Paid":"Partial";d+=y,x+=_,o+=h,n.push([((f=(j=m==null?void 0:m.purchase)==null?void 0:j.vendor)==null?void 0:f.name)||"-",y.toFixed(2),_.toFixed(2),h.toFixed(2),i,new Date(m.created_at).toLocaleDateString("en-GB")])}),n.push(["Total:",d.toFixed(2),x.toFixed(2),o.toFixed(2),"",""]),a.autoTable({head:[c],body:n,startY:52,theme:"grid",styles:{fontSize:10,cellPadding:4,lineColor:[44,62,80],lineWidth:.1},headStyles:{fillColor:[52,152,219],textColor:[255,255,255],fontStyle:"bold",halign:"center",fontSize:11},columnStyles:{0:{cellWidth:45,halign:"left"},1:{cellWidth:28,halign:"right"},2:{cellWidth:28,halign:"right"},3:{cellWidth:28,halign:"right"},4:{cellWidth:25,halign:"center"},5:{cellWidth:30,halign:"center"}},alternateRowStyles:{fillColor:[245,245,245]},didParseCell:m=>{m.row.index===n.length-1&&(m.cell.styles.fontStyle="bold",m.cell.styles.fillColor=[220,230,241])}}),a.save(`vendor-payments-${l.replace(/\s+/g,"-")}-${Date.now()}.pdf`)},yt=(r,l)=>{let a=0,c=0,n=0;const d=r.map(h=>{var F,M;const u=parseFloat(h.amount),i=parseFloat(h.paid_amount),j=parseFloat(h.balance_amount),f=i/u,L=f===0?"Unpaid":f===1?"Paid":"Partial";return a+=u,c+=i,n+=j,{"Vendor Name":((M=(F=h==null?void 0:h.purchase)==null?void 0:F.vendor)==null?void 0:M.name)||"-",Total:u.toFixed(2),Paid:i.toFixed(2),Balance:j.toFixed(2),Status:L,Created:new Date(h.created_at).toLocaleDateString("en-GB")}});d.push({"Vendor Name":"Total:",Total:a.toFixed(2),Paid:c.toFixed(2),Balance:n.toFixed(2),Status:"",Created:""});const x=A.book_new(),o=A.aoa_to_sheet([]),m=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});A.sheet_add_aoa(o,[["Purchase Vendor Payments Report"],[`Project: ${l}`],[`Generated on: ${m}`],[]],{origin:"A1"}),A.sheet_add_json(o,d,{origin:"A5",skipHeader:!1});const y=["A","B","C","D","E","F"];y.forEach(h=>{const u=`${h}5`;o[u]&&(o[u].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"3498DB"}},alignment:{horizontal:"center"}})});const _=4+d.length+1;y.forEach(h=>{const u=o[`${h}${_}`];u&&(u.s={font:{bold:!0},fill:{fgColor:{rgb:"DCE6F1"}},alignment:{horizontal:h==="A"?"left":"right"}})}),o["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:15},{wch:12},{wch:18}],o["!merges"]=[{s:{r:0,c:0},e:{r:0,c:5}},{s:{r:1,c:0},e:{r:1,c:5}},{s:{r:2,c:0},e:{r:2,c:5}}],A.book_append_sheet(x,o,"Payments"),ce(x,`vendor-payments-${l.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},jt=(r,l)=>{const a=new oe("landscape");a.setFontSize(18).setFont("helvetica","bold").text("All Vendor Payment Logs",14,15),a.setFontSize(12).setFont("helvetica","normal").text(`Project: ${l}`,14,23),a.setFontSize(10).text(`Generated: ${new Date().toLocaleString("en-GB")}`,14,30);const c=[];let n=0,d=0,x=0;r.forEach(o=>{var i,j,f,L;const m=((j=(i=o.purchase)==null?void 0:i.vendor)==null?void 0:j.name)||"Unknown",y=((f=o.purchase)==null?void 0:f.material_name)||"-",_=parseFloat(o.amount),h=parseFloat(o.paid_amount),u=parseFloat(o.balance_amount);n+=_,d+=h,x+=u,c.push([{content:`Vendor: ${m} | Material: ${y}`,colSpan:6,styles:{fontStyle:"bold",fillColor:[230,240,255],fontSize:11,textColor:[20,40,90]}},{content:_.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:h.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:u.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:u===0?[220,255,220]:[255,230,230]}}]),((L=o.logs)==null?void 0:L.length)>0?o.logs.forEach((F,M)=>{var k;c.push([M+1,F.paid_by||"-",F.payment_type||"-",parseFloat(F.amount).toFixed(2),new Date(F.payment_date).toLocaleDateString("en-GB"),(F.description||"-").substring(0,40)+(((k=F.description)==null?void 0:k.length)>40?"...":""),"","",""])}):c.push([{content:"No payments yet",colSpan:6,styles:{fontStyle:"italic",textColor:[150,150,150]}},"","",""]),c.push(["","","","","","","","",""])}),c.push([{content:"GRAND TOTAL",colSpan:6,styles:{fontStyle:"bold",fillColor:[200,230,200],fontSize:11}},{content:n.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:d.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:x.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:x===0?[180,255,180]:[255,180,180]}}]),a.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description","Total","Paid","Balance"]],body:c,startY:35,theme:"grid",styles:{fontSize:8.5,cellPadding:2.5,lineColor:[180,180,180],lineWidth:.1},headStyles:{fillColor:[30,100,180],textColor:255,fontStyle:"bold",fontSize:9},columnStyles:{0:{cellWidth:12},1:{cellWidth:32},2:{cellWidth:22},3:{cellWidth:24},4:{cellWidth:26},5:{cellWidth:78},6:{cellWidth:28,halign:"right"},7:{cellWidth:28,halign:"right"},8:{cellWidth:28,halign:"right"}},margin:{top:35,left:8,right:8}}),a.save(`All_Logs_${l.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}.pdf`)},ft=(r,l)=>{const a=[];let c=0,n=0,d=0;r.forEach(y=>{var f,L,F,M;const _=((L=(f=y.purchase)==null?void 0:f.vendor)==null?void 0:L.name)||"Unknown",h=((F=y.purchase)==null?void 0:F.material_name)||"-",u=parseFloat(y.amount),i=parseFloat(y.paid_amount),j=parseFloat(y.balance_amount);c+=u,n+=i,d+=j,a.push({"Vendor → Material":`${_} → ${h}`,"#":"","Paid By":"",Type:"",Amount:"","Payment Date":"",Description:"",Total:u.toFixed(2),Paid:i.toFixed(2),Balance:j.toFixed(2)}),((M=y.logs)==null?void 0:M.length)>0?y.logs.forEach((k,J)=>{a.push({"Vendor → Material":"","#":J+1,"Paid By":k.paid_by||"-",Type:k.payment_type||"-",Amount:parseFloat(k.amount).toFixed(2),"Payment Date":new Date(k.payment_date).toLocaleDateString("en-GB"),Description:k.description||"-",Total:"",Paid:"",Balance:""})}):a.push({"Vendor → Material":"","#":"","Paid By":"No payments yet",Total:"",Paid:"",Balance:""}),a.push({})}),a.push({"Vendor → Material":"GRAND TOTAL",Total:c.toFixed(2),Paid:n.toFixed(2),Balance:d.toFixed(2)});const x=A.book_new(),o=A.aoa_to_sheet([]),m=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});A.sheet_add_aoa(o,[["All Vendor Payment Logs (Detailed)"],[`Project: ${l}`],[`Generated on: ${m}`],[]],{origin:"A1"}),A.sheet_add_json(o,a,{origin:"A5",skipHeader:!1}),o["!cols"]=[{wch:40},{wch:8},{wch:25},{wch:15},{wch:15},{wch:18},{wch:35},{wch:15},{wch:15},{wch:15}],o["!merges"]=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}},{s:{r:2,c:0},e:{r:2,c:9}}],A.book_append_sheet(x,o,"All Payment Logs"),ce(x,`all-payment-logs-${l.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},gt=r=>{const l=new oe("landscape");l.setFontSize(18).text("Vendor Payment Report",14,15),l.setFontSize(12).text(`Project: ${r.vendor_details.project.project_name}`,14,25),l.setFontSize(10).text(`Generated: ${new Date().toLocaleString()}`,14,32);const a=[[`Vendor: ${r.vendor_details.vendor_name}`,`Material: ${r.vendor_details.material_name}`,`Total: ${r.payment_master.total_amount}`,`Paid: ${r.payment_master.paid_amount}`,`Balance: ${r.payment_master.balance_amount}`]];l.autoTable({body:a,startY:40,theme:"plain",columnStyles:{0:{cellWidth:70},1:{cellWidth:70},2:{cellWidth:35},3:{cellWidth:35},4:{cellWidth:35}}});const c=r.payment_logs.map((n,d)=>[d+1,n.paid_by,n.payment_type,Number(n.amount).toFixed(2),new Date(n.payment_date).toLocaleDateString("en-GB"),n.description||"-"]);l.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description"]],body:c,startY:l.lastAutoTable.finalY+10,headStyles:{fillColor:[0,72,144],textColor:"#fff"},alternateRowStyles:{fillColor:[240,248,255]}}),l.save(`Vendor_Payment_${r.vendor_details.vendor_name.replace(/\s+/g,"_")}.pdf`)},_t=r=>{const l=[];l.push(["Vendor Payment Report"],[],[`Project: ${r.vendor_details.project.project_name}`],[`Generated: ${new Date().toLocaleString()}`],[]),l.push([`Vendor: ${r.vendor_details.vendor_name}`,`Material: ${r.vendor_details.material_name}`,`Total: ${r.payment_master.total_amount}`,`Paid: ${r.payment_master.paid_amount}`,`Balance: ${r.payment_master.balance_amount}`]),l.push([],["No.","Paid By","Type","Amount","Date","Description"]),r.payment_logs.forEach((n,d)=>{l.push([d+1,n.paid_by,n.payment_type,Number(n.amount).toFixed(2),new Date(n.payment_date).toLocaleDateString("en-GB"),n.description||"-"])});const a=A.aoa_to_sheet(l);a["!cols"]=[{wch:8},{wch:20},{wch:15},{wch:15},{wch:15},{wch:40}];const c=A.book_new();A.book_append_sheet(c,a,"Vendor Logs"),ce(c,`Vendor_Payment_${r.vendor_details.vendor_name.replace(/\s+/g,"_")}.xlsx`)},Kt=()=>{const[r,l]=p.useState(""),[a,c]=p.useState(""),[n,d]=p.useState([]),[x,o]=p.useState([]),[m,y]=p.useState(!1),[_,h]=p.useState([]),[u,i]=p.useState(!1),j=p.useRef(null),f=p.useRef(null),[L,F]=p.useState(!1),[M,k]=p.useState(!1),[J,de]=p.useState(!1),[Le,ee]=p.useState(!1),[W,Be]=p.useState(null),[te,me]=p.useState(null),[$e,he]=p.useState(!1),[ae,pe]=p.useState(!1),[bt,ue]=p.useState(null),[w,re]=p.useState({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:"",project_id:"",payment_id:null}),[Me,I]=p.useState(""),[b,G]=p.useState({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null}),[Ee,E]=p.useState(""),[ze,xe]=p.useState(!1),{showToast:q}=Ke(),Ve=async()=>{try{const t=await O("/api/getPurchesVendor");o(t||[])}catch{q("danger","Failed to load vendors")}},se=async()=>{if(r){y(!0);try{const t=await O(`/api/getPurchesVedorPayment?project_id=${r}`);t&&t.success&&Array.isArray(t.data)?d(t.data):d([])}catch{q("danger","Failed to load payments"),d([])}finally{y(!1)}}},We=async t=>{he(!0);try{const s=await O(`/api/getVendorPaymentDetails/${t}`);me(s)}catch{q("danger","Failed to load payment logs"),me(null)}finally{he(!1)}},Re=async t=>{var D,S,P,R;if(E(""),!b.paid_by.trim())return E("Paid by is required");if(!b.payment_type.trim())return E("Payment type is required");if(!b.amount||b.amount<=0)return E("Amount must be > 0");if(!b.payment_date)return E("Payment date is required");if(Number(b.amount)>Number(W==null?void 0:W.balance_amount))return E(`Amount cannot be more than pending balance ₹${W==null?void 0:W.balance_amount}`);if(t==="upload"&&!b.payment_file)return E("Payment file is required");const s=new FormData;s.append("purches_vendor_id",b.purches_vendor_id),s.append("paid_by",b.paid_by),s.append("payment_type",b.payment_type),s.append("amount",parseFloat(b.amount)),s.append("payment_date",b.payment_date),(D=b.description)!=null&&D.trim()&&s.append("description",b.description),(S=b.remark)!=null&&S.trim()&&s.append("remark",b.remark),b.payment_file&&s.append("payment_file",b.payment_file),xe(!0);try{const V=await Xe("/api/addVendorPayment",s);q("success",V.message||"Payment added successfully!"),F(!1),He(),se()}catch(V){const U=((R=(P=V.response)==null?void 0:P.data)==null?void 0:R.message)||"Payment failed";E(U)}finally{xe(!1)}},ye=p.useCallback(async t=>{if(!t.trim()){h([]);return}try{const s=await O(`/api/projects?searchQuery=${t}`);h(s||[])}catch{h([])}},[]);p.useEffect(()=>{const t=setTimeout(()=>{a.length>2?ye(a):(h([]),i(!1))},300);return()=>clearTimeout(t)},[a,ye]),p.useEffect(()=>{const t=s=>{j.current&&!j.current.contains(s.target)&&i(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),p.useEffect(()=>{r?se():d([])},[r]);const je=t=>{c(t.project_name),l(t.id),h([]),i(!1),f.current&&f.current.blur()},fe=()=>{pe(!1),ue(null),re({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:new Date().toISOString().split("T")[0],project_id:r,payment_id:null}),I(""),k(!0)},qe=t=>{pe(!0),ue(t.id);const s=t.purchase||{};re({vendor_id:s.vendor_id||"",material_name:s.material_name||"",about:s.about||"",qty:parseFloat(s.qty)||"",price:parseFloat(s.price_per_unit)||"",total:parseFloat(s.total)||0,date:s.date||new Date().toISOString().split("T")[0],project_id:r,payment_id:t.id}),I(""),k(!0)},Ie=t=>{const{name:s,value:D}=t.target;re(S=>{const P={...S,[s]:D};if(s==="qty"||s==="price"){const R=s==="qty"?parseFloat(D)||0:parseFloat(S.qty)||0,V=s==="price"?parseFloat(D)||0:parseFloat(S.price)||0;P.total=(R*V).toFixed(2)}return P})},Ge=()=>w.vendor_id?w.material_name.trim()?!w.qty||w.qty<=0?"Qty must be > 0":!w.price||w.price<=0?"Price must be > 0":w.date?"":"Date is required":"Material name is required":"Vendor is required",Ue=async()=>{var D,S;const t=Ge();if(t)return I(t);const s={project_id:parseInt(r),vendor_id:parseInt(w.vendor_id),material_name:w.material_name,about:w.about||null,price_per_unit:parseFloat(w.price),qty:parseFloat(w.qty),total:parseFloat(w.total),date:w.date};try{ae?await Je("/api/updatePurchesVendorPayment",{...s,payment_id:w.payment_id}):await et("/api/purchesVendor",s),q("success",ae?"Updated successfully!":"Added successfully!"),k(!1),se()}catch(P){I(((S=(D=P.response)==null?void 0:D.data)==null?void 0:S.message)||"Operation failed")}},Oe=t=>{Be(t),G({purches_vendor_id:t.purches_vendor_id,paid_by:"",payment_type:"",amount:"",payment_date:new Date().toISOString().split("T")[0],description:""}),E(""),F(!0)},He=()=>{G({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null})},Ze=t=>{const{name:s,value:D,files:S}=t.target;s==="payment_file"&&S&&S[0]?G(P=>({...P,payment_file:S[0]})):G(P=>({...P,[s]:D}))},Ye=async t=>{de(!0),await We(t)};return p.useEffect(()=>{Ve()},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Se,{className:"mb-4",children:[e.jsxs(Ne,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Purchase Vendor Payments"}),e.jsxs("div",{children:[r&&n.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(g,{size:"sm",color:"light",className:"me-2",onClick:()=>xt(n,a),children:[e.jsx(B,{icon:Ce})," PDF"]}),e.jsxs(g,{size:"sm",color:"light",className:"me-2",onClick:()=>yt(n,a),children:[e.jsx(B,{icon:Ae})," Excel"]})]}),n.some(t=>{var s;return((s=t.logs)==null?void 0:s.length)>0})&&e.jsxs(e.Fragment,{children:[e.jsx(g,{size:"sm",color:"light",className:"me-2",onClick:()=>jt(n,a),children:"All Logs PDF"}),e.jsx(g,{size:"sm",color:"light",onClick:()=>ft(n,a),children:"All Logs Excel"})]})]})]}),e.jsxs(Pe,{children:[e.jsx(z,{className:"mb-4",children:e.jsx(v,{md:12,children:e.jsxs("div",{className:"position-relative",ref:j,children:[e.jsxs(lt,{children:[e.jsx($,{ref:f,type:"text",placeholder:"Search and select project...",value:a,onChange:t=>{c(t.target.value),r&&t.target.value!==a&&l("")},onFocus:()=>_.length>0&&i(!0),autoComplete:"off"}),r?e.jsx(g,{color:"danger",variant:"outline",onClick:()=>{c(""),l(""),d([])},children:e.jsx(B,{icon:ct})}):e.jsx(g,{color:"primary",variant:"outline",onClick:()=>ee(!0),children:e.jsx(B,{icon:ot})})]}),u&&_.length>0&&e.jsx("div",{className:"border bg-white shadow-sm rounded",style:{position:"absolute",top:"100%",left:0,right:0,maxHeight:"200px",overflowY:"auto",zIndex:1e3,marginTop:"2px"},children:_.map(t=>e.jsx("div",{className:"px-3 py-2 hover-bg-light cursor-pointer",style:{cursor:"pointer"},onClick:()=>je(t),children:t.project_name},t.id))}),r&&e.jsxs("small",{className:"text-success d-block mt-1",children:["Selected: ",e.jsx("strong",{children:a})]})]})})}),m?e.jsx("div",{className:"text-center py-4",children:e.jsx(ie,{})}):n.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(Te,{striped:!0,hover:!0,children:[e.jsx(ke,{color:"light",children:e.jsxs(X,{children:[e.jsx(N,{children:"Vendor Name"}),e.jsx(N,{children:"Total"}),e.jsx(N,{children:"Paid"}),e.jsx(N,{children:"Balance"}),e.jsx(N,{children:"Status"}),e.jsx(N,{children:"Created"}),e.jsx(N,{children:"Actions"})]})}),e.jsx(De,{children:n.map(t=>{var R,V,U;const s=parseFloat(t.paid_amount)/parseFloat(t.amount)*100,D=s===0?"danger":s===100?"success":"warning",S=s===0?"Unpaid":s===100?"Paid":"Partial",P=parseFloat(t.balance_amount)>0;return e.jsxs(X,{children:[e.jsx(T,{children:(V=(R=t==null?void 0:t.purchase)==null?void 0:R.vendor)==null?void 0:V.name}),e.jsxs(T,{children:["₹",parseFloat(t.amount).toFixed(2)]}),e.jsxs(T,{children:["₹",parseFloat(t.paid_amount).toFixed(2)]}),e.jsxs(T,{children:["₹",parseFloat(t.balance_amount).toFixed(2)]}),e.jsx(T,{children:e.jsx(ne,{color:D,children:S})}),e.jsx(T,{children:new Date(t.created_at).toLocaleDateString()}),e.jsxs(T,{children:[e.jsxs(g,{color:"info",size:"sm",className:"me-1",onClick:()=>Ye(t.purches_vendor_id),disabled:!t.logs||t.logs.length===0,children:[e.jsx(B,{icon:mt})," Logs (",((U=t.logs)==null?void 0:U.length)||0,")"]}),e.jsxs(g,{color:"success",size:"sm",className:"me-1",onClick:()=>Oe(t),disabled:!P,title:P?"Make Payment":"Fully Paid",children:[e.jsx(B,{icon:it})," Pay"]}),e.jsx(g,{color:"warning",size:"sm",className:"me-1",onClick:()=>qe(t),children:e.jsx(B,{icon:dt})})]})]},t.id)})})]})}):r?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("h5",{className:"text-muted",children:"No payments yet"}),e.jsxs(g,{color:"primary",onClick:fe,children:[e.jsx(B,{icon:Fe,className:"me-1"}),"Add First Material"]})]}):e.jsx("div",{className:"text-center py-5",children:e.jsx("h5",{className:"text-muted",children:"Select a project to view payments"})}),r&&!m&&e.jsx("div",{className:"mt-3",children:e.jsxs(g,{color:"success",onClick:fe,children:[e.jsx(B,{icon:Fe,className:"me-1"}),"Add Material"]})})]})]}),e.jsx(ht,{visible:L,onClose:()=>F(!1),payForm:b,payError:Ee,payLoading:ze,onChange:Ze,onSubmit:Re,selectedVendorPayment:W}),e.jsx(pt,{visible:M,onClose:()=>k(!1),isEdit:ae,form:w,vendors:x,onChange:Ie,onSubmit:Ue,error:Me}),e.jsx(ut,{visible:J,onClose:()=>de(!1),logsData:te,loading:$e,onDownloadPDF:()=>gt(te),onDownloadExcel:()=>_t(te)}),e.jsx(tt,{visible:Le,onClose:()=>ee(!1),onSelectProject:t=>{je(t),ee(!1)}})]})};export{Kt as default};
