import{d as Ce,u as _e,b as Pe,r as l,j as e,C as ee}from"./index-C2h9iXsq.js";import{a as h,b as i,c as b}from"./index.esm-DQbyd5df.js";import{a as te,b as Ae}from"./api-C2dAnRUz.js";import{C as z,a as V}from"./CCardBody-DHWC5_BS.js";import{C as Ne}from"./cil-mobile-CRjBRZgk.js";import{C as g}from"./CButton--W_4ZeJh.js";import{C as ke}from"./CCardHeader-BOYr8GAh.js";import{c as Fe}from"./cil-arrow-left-D66Kb3Zq.js";import{C as Se}from"./CForm-BVvPNiqY.js";import{C as u}from"./CFormLabel-DkkhltaS.js";import{C as c}from"./CFormInput-Da28fgYD.js";import{C as we}from"./CFormSelect-ukCskt8P.js";import{C as p}from"./CInputGroup-DQyo9You.js";import{C as j}from"./CInputGroupText-UmKIgDi2.js";import{C as se}from"./DefaultLayout-Bb3k2Kjc.js";import{c as re}from"./cil-pencil-m516yCOw.js";import{c as ne}from"./cil-x-0440B5Ce.js";import{C as Te}from"./CFormTextarea-OofZxR1Z.js";import{c as Ie}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-CgtL4Ts4.js";import"./RawMaterial-BtjEDAbB.js";const tt=()=>{var K,Y,Z;const{id:f}=Ce(),C=_e(),{showToast:E}=Pe(),[ae,B]=l.useState(!0),[q,$]=l.useState(!1),[oe,ie]=l.useState(!1),[Ee,ce]=l.useState([]),[le,me]=l.useState([]),[v,de]=l.useState(null),[o,D]=l.useState({tally_invoice_number:"",invoice_date:"",delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",status:"draft",terms_conditions:"",payment_terms:""}),[y,k]=l.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}]),[_,F]=l.useState([]),[ue,W]=l.useState(-1),[L,U]=l.useState(""),[G,H]=l.useState(""),[P,S]=l.useState([]),[pe,R]=l.useState(-1),[M,Q]=l.useState(""),[O,X]=l.useState("");l.useEffect(()=>{ge(),xe()},[f]);const ge=async()=>{var n,s;try{B(!0);const r=await te(`/api/proforma-invoices/${f}`);if(r&&r.success&&r.data){const t=r.data;de(t),D({tally_invoice_number:t.tally_invoice_number||"",invoice_date:((n=t.invoice_date)==null?void 0:n.split("T")[0])||"",delivery_date:((s=t.delivery_date)==null?void 0:s.split("T")[0])||"",discount:parseFloat(t.discount)||0,subtotal:parseFloat(t.subtotal)||0,taxableAmount:parseFloat(t.taxable_amount)||0,gstAmount:parseFloat(t.gst_amount)||0,sgstAmount:parseFloat(t.sgst_amount)||0,cgstAmount:parseFloat(t.cgst_amount)||0,igstAmount:parseFloat(t.igst_amount)||0,finalAmount:parseFloat(t.final_amount)||0,gstPercentage:parseFloat(t.gst_percentage)||18,sgstPercentage:parseFloat(t.sgst_percentage)||9,cgstPercentage:parseFloat(t.cgst_percentage)||9,igstPercentage:parseFloat(t.igst_percentage)||0,notes:t.notes||"",status:t.status||"draft",terms_conditions:t.terms_conditions||"",payment_terms:t.payment_terms||""}),t.details&&t.details.length>0&&k(t.details.map(a=>({work_type:a.work_type||"",uom:a.uom||"",qty:parseFloat(a.qty)||0,price:parseFloat(a.price)||0,total_price:parseFloat(a.total_price)||0,remark:a.remark||""}))),t.payment_terms&&F(t.payment_terms.split(`
`).filter(a=>a.trim())),t.terms_conditions&&S(t.terms_conditions.split(`
`).filter(a=>a.trim())),t.invoice_rules&&t.invoice_rules.length>0&&me(t.invoice_rules.map(a=>a.rules_id))}}catch(r){console.error("Error fetching proforma invoice:",r),E("danger","Failed to load proforma invoice"),setTimeout(()=>C("/invoiceTable"),2e3)}finally{B(!1)}},xe=async()=>{try{const n=await te("/api/rules");ce(Array.isArray(n)?n:[])}catch(n){console.error("Error fetching rules:",n)}},x=n=>{const{name:s,value:r}=n.target;D(t=>{let a={...t,[s]:s==="discount"||s.endsWith("Percentage")?parseFloat(r)||0:r};if(s==="gstPercentage"){const m=(parseFloat(r)||0)/2;a={...a,sgstPercentage:m,cgstPercentage:m}}else if(s==="sgstPercentage"||s==="cgstPercentage"){const d=s==="sgstPercentage"?parseFloat(r)||0:t.sgstPercentage,m=s==="cgstPercentage"?parseFloat(r)||0:t.cgstPercentage;a={...a,gstPercentage:d+m}}if(s==="discount"||s.endsWith("Percentage")){const d=y.reduce((ve,be)=>ve+(be.total_price||0),0),m=d-a.discount,N=m*(a.sgstPercentage/100),w=m*(a.cgstPercentage/100),T=m*(a.igstPercentage/100),I=N+w+T,fe=m+I;a={...a,subtotal:d,taxableAmount:m,gstAmount:I,sgstAmount:N,cgstAmount:w,igstAmount:T,finalAmount:fe}}return a})},A=(n,s,r)=>{const t=[...y];t[n][s]=s==="qty"||s==="price"?parseFloat(r)||0:r,t[n].total_price=(t[n].qty||0)*(t[n].price||0),k(t),J(t)},he=()=>{k([...y,{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}])},je=n=>{if(y.length===1)return;const s=[...y];s.splice(n,1),k(s),J(s)},J=n=>{D(s=>{const r=n.reduce((T,I)=>T+(I.total_price||0),0),t=r-(s.discount||0),a=t*(s.sgstPercentage/100),d=t*(s.cgstPercentage/100),m=t*(s.igstPercentage/100),N=a+d+m,w=t+N;return{...s,subtotal:r,taxableAmount:t,gstAmount:N,sgstAmount:a,cgstAmount:d,igstAmount:m,finalAmount:w}})},ye=async n=>{var r,t;if(n.preventDefault(),!n.currentTarget.checkValidity()){ie(!0);return}try{$(!0);const a={tally_invoice_number:o.tally_invoice_number||null,invoice_date:o.invoice_date,delivery_date:o.delivery_date||null,items:y.filter(m=>m.work_type&&m.qty>0),discount:o.discount,gst_percentage:o.gstPercentage,cgst_percentage:o.cgstPercentage,sgst_percentage:o.sgstPercentage,igst_percentage:o.igstPercentage,rule_ids:le,notes:o.notes||null,status:o.status,terms_conditions:P.join(`
`)||null,payment_terms:_.join(`
`)||null},d=await Ae(`/api/proforma-invoices/${f}`,a);if(d&&d.success)E("success","Proforma invoice updated successfully"),setTimeout(()=>{C(`/proforma-invoice-details/${f}`)},1500);else throw new Error(d.message||"Failed to update proforma invoice")}catch(a){console.error("Update error:",a);const d=((t=(r=a.response)==null?void 0:r.data)==null?void 0:t.message)||"Failed to update proforma invoice";E("danger",d)}finally{$(!1)}};return ae?e.jsx(z,{children:e.jsxs(V,{className:"text-center py-5",children:[e.jsx(ee,{color:"primary"}),e.jsx("div",{className:"mt-3",children:"Loading proforma invoice..."})]})}):v?e.jsx(h,{children:e.jsx(i,{xs:12,children:e.jsxs(z,{className:"mb-4",children:[e.jsx(ke,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("strong",{children:["Edit Proforma Invoice #",v.proforma_invoice_number]}),e.jsxs(g,{color:"secondary",size:"sm",onClick:()=>C(`/proforma-invoice-details/${f}`),children:[e.jsx(b,{icon:Fe,className:"me-1"}),"Back to Details"]})]})}),e.jsxs(V,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(h,{children:[e.jsxs(i,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order #:"}),e.jsx("div",{children:e.jsx("strong",{children:(K=v.work_order)==null?void 0:K.invoice_number})})]}),e.jsxs(i,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=v.project)==null?void 0:Y.project_name})})]}),e.jsxs(i,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Z=v.customer)==null?void 0:Z.name})})]}),e.jsxs(i,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Payment Status:"}),e.jsx("div",{children:e.jsx("strong",{className:"text-capitalize",children:v.payment_status})})]})]})]}),e.jsxs(Se,{validated:oe,onSubmit:ye,children:[e.jsxs(h,{className:"mb-3",children:[e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Tally Invoice Number"}),e.jsx(c,{type:"text",name:"tally_invoice_number",value:o.tally_invoice_number,onChange:x,placeholder:"Optional"})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Invoice Date *"}),e.jsx(c,{type:"date",name:"invoice_date",value:o.invoice_date,onChange:x,required:!0})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Delivery Date"}),e.jsx(c,{type:"date",name:"delivery_date",value:o.delivery_date,onChange:x})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Status"}),e.jsxs(we,{name:"status",value:o.status,onChange:x,children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"sent",children:"Sent"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),y.map((n,s)=>e.jsxs(h,{className:"g-3 mb-3 align-items-center",children:[e.jsx(i,{md:2,children:e.jsx(c,{placeholder:"Work Type",value:n.work_type,onChange:r=>A(s,"work_type",r.target.value),required:!0})}),e.jsx(i,{md:2,children:e.jsx(c,{placeholder:"Unit",value:n.uom,onChange:r=>A(s,"uom",r.target.value)})}),e.jsx(i,{md:2,children:e.jsx(c,{type:"number",placeholder:"Quantity",value:n.qty,onChange:r=>A(s,"qty",r.target.value),min:"0",required:!0})}),e.jsx(i,{md:2,children:e.jsxs(p,{children:[e.jsx(j,{children:"₹"}),e.jsx(c,{type:"number",placeholder:"Price",value:n.price,onChange:r=>A(s,"price",r.target.value),min:"0",step:"0.01",required:!0})]})}),e.jsx(i,{md:1,children:e.jsxs("span",{className:"text-success fw-medium",children:["₹",n.total_price.toFixed(2)]})}),e.jsx(i,{md:2,children:e.jsx(c,{placeholder:"Remark",value:n.remark,onChange:r=>A(s,"remark",r.target.value)})}),e.jsx(i,{md:1,children:e.jsx(g,{color:"danger",size:"sm",onClick:()=>je(s),disabled:y.length===1,children:"×"})})]},s)),e.jsx(g,{color:"warning",variant:"outline",className:"mb-4",onClick:he,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(h,{className:"mb-3",children:[e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Total GST (%)"}),e.jsxs(p,{children:[e.jsx(c,{type:"number",name:"gstPercentage",value:o.gstPercentage,onChange:x,min:"0",max:"100",step:"0.01"}),e.jsx(j,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",o.gstAmount.toFixed(2)]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"SGST (%)"}),e.jsxs(p,{children:[e.jsx(c,{type:"number",name:"sgstPercentage",value:o.sgstPercentage,onChange:x,min:"0",max:"50",step:"0.01"}),e.jsx(j,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",o.sgstAmount.toFixed(2)]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"CGST (%)"}),e.jsxs(p,{children:[e.jsx(c,{type:"number",name:"cgstPercentage",value:o.cgstPercentage,onChange:x,min:"0",max:"50",step:"0.01"}),e.jsx(j,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",o.cgstAmount.toFixed(2)]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"IGST (%)"}),e.jsxs(p,{children:[e.jsx(c,{type:"number",name:"igstPercentage",value:o.igstPercentage,onChange:x,min:"0",max:"100",step:"0.01"}),e.jsx(j,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",o.igstAmount.toFixed(2)]})]})]}),e.jsxs(h,{className:"mb-3",children:[e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Subtotal"}),e.jsxs(p,{children:[e.jsx(j,{children:"₹"}),e.jsx(c,{type:"number",value:o.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Discount"}),e.jsxs(p,{children:[e.jsx(j,{children:"₹"}),e.jsx(c,{type:"number",name:"discount",value:o.discount,onChange:x,min:"0",step:"0.01"})]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Taxable Amount"}),e.jsxs(p,{children:[e.jsx(j,{children:"₹"}),e.jsx(c,{type:"number",value:o.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(i,{md:3,children:[e.jsx(u,{children:"Final Amount"}),e.jsxs(p,{children:[e.jsx(j,{children:"₹"}),e.jsx(c,{type:"number",value:o.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:_.map((n,s)=>ue===s?e.jsxs(p,{style:{width:"auto"},children:[e.jsx(c,{value:L,onChange:r=>U(r.target.value)}),e.jsx(g,{color:"success",onClick:()=>{const r=[..._];r[s]=L.trim(),F(r),W(-1)},children:"Save"}),e.jsx(g,{color:"secondary",onClick:()=>W(-1),children:"Cancel"})]},s):e.jsxs(se,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(b,{icon:re,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{W(s),U(n)}}),e.jsx(b,{icon:ne,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{F(_.filter((r,t)=>t!==s))}})]},s))}),e.jsx(h,{className:"mb-3",children:e.jsx(i,{md:6,children:e.jsxs(p,{children:[e.jsx(c,{placeholder:"Add new payment term...",value:G,onChange:n=>H(n.target.value)}),e.jsx(g,{color:"primary",onClick:()=>{G.trim()&&(F([..._,G.trim()]),H(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:P.map((n,s)=>pe===s?e.jsxs(p,{style:{width:"auto"},children:[e.jsx(c,{value:M,onChange:r=>Q(r.target.value)}),e.jsx(g,{color:"success",onClick:()=>{const r=[...P];r[s]=M.trim(),S(r),R(-1)},children:"Save"}),e.jsx(g,{color:"secondary",onClick:()=>R(-1),children:"Cancel"})]},s):e.jsxs(se,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[n,e.jsx(b,{icon:re,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{R(s),Q(n)}}),e.jsx(b,{icon:ne,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{S(P.filter((r,t)=>t!==s))}})]},s))}),e.jsx(h,{className:"mb-3",children:e.jsx(i,{md:6,children:e.jsxs(p,{children:[e.jsx(c,{placeholder:"Add new condition...",value:O,onChange:n=>X(n.target.value)}),e.jsx(g,{color:"primary",onClick:()=>{O.trim()&&(S([...P,O.trim()]),X(""))},children:"Add"})]})})}),e.jsx(h,{className:"mb-3",children:e.jsxs(i,{md:12,children:[e.jsx(u,{children:"Additional Notes"}),e.jsx(Te,{name:"notes",value:o.notes,onChange:x,rows:3,placeholder:"Enter any additional notes..."})]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(g,{color:"primary",type:"submit",disabled:q,children:[q?e.jsx(ee,{size:"sm"}):e.jsx(b,{icon:Ie,className:"me-1"}),"Update Proforma Invoice"]}),e.jsx(g,{color:"secondary",onClick:()=>C(`/proforma-invoice-details/${f}`),disabled:q,children:"Cancel"})]})]})]})]})})}):e.jsx(z,{children:e.jsx(V,{children:e.jsxs(Ne,{color:"danger",children:[e.jsx("h5",{children:"Proforma Invoice Not Found"}),e.jsx("p",{children:"The requested proforma invoice could not be found."}),e.jsx(g,{color:"primary",onClick:()=>C("/invoiceTable"),children:"Back to Orders"})]})})})};export{tt as default};
