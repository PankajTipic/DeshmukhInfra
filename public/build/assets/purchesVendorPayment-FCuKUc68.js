import{r as x,j as e,C as le,b as rt}from"./index-D77JVx93.js";import{a as I,b as g,c as M}from"./index.esm-CnYARBHd.js";import{h as nt,a as O,c as st,b as it,p as lt}from"./api-C2dAnRUz.js";import{P as ot}from"./ProjectSelectionModal-DvSrAtUM.js";import{r as ct,p as dt}from"./Feilds-BHjWXeSc.js";import{a as H,b as Z,c as Y,d as K,f as mt,g as Ce,h as Se,i as ht,j as Pe,e as Q,C as ie,n as pt}from"./DefaultLayout-B9m2Op0L.js";import{C as Te}from"./CForm-CvVYu-wE.js";import{C as F}from"./CFormLabel-Dc8HuNh9.js";import{C as ke}from"./CFormSelect-BEYL04sy.js";import{C as N}from"./CFormInput-l8xIFq1a.js";import{C as oe}from"./cil-mobile-CeKkmNgt.js";import{C as w}from"./CButton-1GsZ7-l4.js";import{c as De}from"./cil-file-CeQgYs_D.js";import{C as Ae,a as Be}from"./CCardBody-CmpV1lA4.js";import{C as Le}from"./CCardHeader-CTLciU6o.js";import{C as Ee,a as $e,b as X,c as S,d as Me,e as P}from"./CTable-_iNV6x85.js";import{E as ce}from"./jspdf.es.min-P9DMHkwx.js";import"./jspdf.plugin.autotable-DMTpKMcF.js";import{utils as L,writeFile as de}from"./xlsx-B6sNpj_1.js";import{C as ut}from"./CInputGroup-iSurCesp.js";import{c as xt}from"./cil-search-CDkY_4k-.js";import{c as yt}from"./cil-x-0440B5Ce.js";import{c as jt}from"./cil-pencil-m516yCOw.js";import{c as Ne}from"./cil-plus-D8mtC-W5.js";import"./RawMaterial-BtjEDAbB.js";import"./CFormControlWrapper-Bm4xoNnJ.js";import"./typeof-QjJsDpFa.js";import"./jspdf.es.min-CzbIXxHz.js";var ft=["512 512","<rect width='264' height='32' x='208' y='80' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M40,96a64,64,0,1,0,64-64A64.072,64.072,0,0,0,40,96Zm64-32A32,32,0,1,1,72,96,32.036,32.036,0,0,1,104,64Z' class='ci-primary'/><rect width='264' height='32' x='208' y='240' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,320a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,320Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,224Z' class='ci-primary'/><rect width='264' height='32' x='208' y='400' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M104,480a64,64,0,1,0-64-64A64.072,64.072,0,0,0,104,480Zm0-96a32,32,0,1,1-32,32A32.036,32.036,0,0,1,104,384Z' class='ci-primary'/>"],Ie=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M16,64V456H496V64ZM464,424H48V96H464Z' class='ci-primary'/><rect width='88' height='32' x='88' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='88' height='32' x='88' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='136' height='32' x='288' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='136' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='208' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='280' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='216' y='352' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/>"];const _t=({visible:r,onClose:i,payForm:a={},payError:o,payLoading:s,onChange:n,onSubmit:f,selectedVendorPayment:l})=>{var d,b,v,T;const[m,_]=x.useState("upload"),C=()=>{if(!a.payment_file)return null;const p=a.payment_file,$=p.type.startsWith("image/"),D=p.type==="application/pdf";return e.jsxs("div",{className:"mt-3 p-3 border rounded bg-light",children:[e.jsx("strong",{children:"Selected file:"})," ",p.name," (",(p.size/1024).toFixed(2)," KB)",$&&e.jsx("div",{className:"mt-2",children:e.jsx("img",{src:URL.createObjectURL(p),alt:"Preview",style:{maxWidth:"100%",maxHeight:"200px",objectFit:"contain"}})}),D&&e.jsx("div",{className:"mt-2 text-primary",children:e.jsx("strong",{children:"PDF file selected"})})]})},h=["imps","neft","rtgs"].includes((d=a.payment_type)==null?void 0:d.toLowerCase()),y=((b=a.payment_type)==null?void 0:b.toLowerCase())==="upi";return e.jsxs(H,{visible:r,onClose:i,backdrop:"static",size:"xl",children:[e.jsx(Z,{onClose:i,children:e.jsx(Y,{children:"Make Payment"})}),e.jsx(K,{children:e.jsxs(Te,{children:[e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Vendor Name"}),e.jsx("div",{className:"form-control bg-light",children:((T=(v=l==null?void 0:l.purchase)==null?void 0:v.vendor)==null?void 0:T.name)||"—"})]}),e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Remaining Balance"}),e.jsxs("div",{className:"form-control text-danger fw-bold",children:["₹",parseFloat((l==null?void 0:l.balance_amount)||0).toFixed(2)]})]})]}),e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Paid By *"}),e.jsxs(ke,{name:"paid_by",value:a.paid_by||"",onChange:n,children:[e.jsx("option",{value:"",children:"Select Paid By"}),ct.map(p=>e.jsx("option",{value:p.value,children:p.label},p.value))]})]}),e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Payment Type *"}),e.jsxs(ke,{name:"payment_type",value:a.payment_type||"",onChange:n,children:[e.jsx("option",{value:"",children:"Select Payment Type"}),dt.map(p=>e.jsx("option",{value:p.value,children:p.label},p.value))]})]})]}),e.jsxs(I,{className:"g-3 mb-4",children:[e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Amount *"}),e.jsx(N,{type:"number",name:"amount",value:a.amount||"",onChange:n,step:"0.01",min:"0.01",placeholder:"0.00"})]}),e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Payment Date *"}),e.jsx(N,{type:"date",name:"payment_date",value:a.payment_date||"",onChange:n,max:new Date().toISOString().split("T")[0]})]})]}),h&&e.jsxs("div",{className:"border rounded p-4 mb-4 bg-light",children:[e.jsx("h6",{className:"mb-3 text-primary",children:"Bank Transfer Details"}),e.jsxs(I,{className:"g-3",children:[e.jsxs(g,{md:6,lg:3,children:[e.jsx(F,{htmlFor:"bank_name",children:"Bank Name *"}),e.jsx(N,{type:"text",id:"bank_name",name:"bank_name",placeholder:"Enter bank name",value:a.bank_name||"",onChange:n})]}),e.jsxs(g,{md:6,lg:3,children:[e.jsx(F,{htmlFor:"acc_number",children:"Account Number *"}),e.jsx(N,{type:"text",id:"acc_number",name:"acc_number",placeholder:"Enter account number",value:a.acc_number||"",onChange:n})]}),e.jsxs(g,{md:6,lg:3,children:[e.jsx(F,{htmlFor:"ifsc",children:"IFSC Code *"}),e.jsx(N,{type:"text",id:"ifsc",name:"ifsc",placeholder:"Enter IFSC code",value:a.ifsc||"",onChange:n})]}),e.jsxs(g,{md:6,lg:3,children:[e.jsx(F,{htmlFor:"transaction_id",children:"Transaction ID / UTR *"}),e.jsx(N,{type:"text",id:"transaction_id",name:"transaction_id",placeholder:"Enter transaction ID",value:a.transaction_id||"",onChange:n})]})]})]}),y&&e.jsx("div",{className:"border rounded p-4 mb-4 bg-light",children:e.jsx(I,{className:"g-3 mb-4",children:e.jsxs(g,{md:6,lg:4,children:[e.jsx(F,{htmlFor:"transaction_id",children:"UPI Transaction ID *"}),e.jsx(N,{type:"text",id:"transaction_id",name:"transaction_id",placeholder:"Enter UPI transaction ID",value:a.transaction_id||"",onChange:n})]})})}),e.jsx(I,{className:"mb-4",children:e.jsxs(g,{children:[e.jsx(F,{children:"Description (optional)"}),e.jsx(N,{name:"description",value:a.description||"",onChange:n,placeholder:"e.g. Payment for material delivery"})]})}),e.jsxs(mt,{variant:"pills",className:"mb-3",children:[e.jsx(Ce,{children:e.jsx(Se,{active:m==="upload",onClick:()=>_("upload"),style:{cursor:"pointer"},children:"Upload Photo / File"})}),e.jsx(Ce,{children:e.jsx(Se,{active:m==="remark",onClick:()=>_("remark"),style:{cursor:"pointer"},children:"Remark"})})]}),e.jsxs(ht,{children:[e.jsxs(Pe,{visible:m==="upload",children:[e.jsx(F,{children:"Upload Photo / File (optional)"}),e.jsx(N,{type:"file",name:"payment_file",accept:"image/png,image/jpeg,image/jpg,application/pdf",onChange:n}),C()]}),e.jsxs(Pe,{visible:m==="remark",children:[e.jsx(F,{children:"Remark (optional)"}),e.jsx("textarea",{className:"form-control",name:"remark",rows:"4",value:a.remark||"",onChange:n,placeholder:"Enter any remark..."})]})]}),o&&e.jsx(oe,{color:"danger",className:"mt-3",children:o})]})}),e.jsxs(Q,{children:[e.jsx(w,{color:"secondary",onClick:i,children:"Cancel"}),e.jsx(w,{color:"primary",onClick:()=>f(m),disabled:s,children:s?e.jsx(le,{size:"sm"}):"Submit Payment"})]})]})},gt=({visible:r,onClose:i,isEdit:a=!1,form:o={},vendors:s=[],onChange:n,onSubmit:f,error:l})=>!o||!s?null:e.jsxs(H,{visible:r,onClose:i,size:"lg",backdrop:"static",children:[e.jsx(Z,{onClose:i,children:e.jsxs(Y,{children:[a?"Edit":"Add"," Material"]})}),e.jsx(K,{children:e.jsxs(Te,{children:[e.jsxs(I,{className:"g-3",children:[e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Vendor *"}),e.jsxs("select",{className:"form-select",name:"vendor_id",value:o.vendor_id||"",onChange:n,children:[e.jsx("option",{value:"",children:"Select Vendor"}),s.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})]}),e.jsxs(g,{md:6,children:[e.jsx(F,{children:"Material Name *"}),e.jsx(N,{name:"material_name",value:o.material_name||"",onChange:n,placeholder:"e.g. Cement, Bricks"})]})]}),e.jsx(I,{className:"g-3 mt-3",children:e.jsxs(g,{children:[e.jsx(F,{children:"About (optional)"}),e.jsx(N,{name:"about",value:o.about||"",onChange:n,placeholder:"Any additional details"})]})}),e.jsxs(I,{className:"g-3 mt-3 align-items-end",children:[e.jsxs(g,{md:3,children:[e.jsx(F,{children:"Qty *"}),e.jsx(N,{type:"number",name:"qty",value:o.qty||"",onChange:n,min:"0.01",step:"0.01"})]}),e.jsxs(g,{md:3,children:[e.jsx(F,{children:"Price/Unit *"}),e.jsx(N,{type:"number",name:"price",value:o.price||"",onChange:n,min:"0",step:"0.01"})]}),e.jsxs(g,{md:3,children:[e.jsx(F,{children:"Total"}),e.jsx(N,{value:o.qty&&o.price?(o.qty*o.price).toFixed(2):"0.00",readOnly:!0,className:"bg-light"})]}),e.jsxs(g,{md:3,children:[e.jsx(F,{children:"Date *"}),e.jsx(N,{type:"date",name:"date",value:o.date||"",onChange:n,max:new Date().toISOString().split("T")[0]})]})]}),l&&e.jsx(oe,{color:"danger",className:"mt-3",children:l})]})}),e.jsxs(Q,{children:[e.jsx(w,{color:"secondary",onClick:i,children:"Cancel"}),e.jsx(w,{color:"primary",onClick:f,children:a?"Update":"Save"})]})]}),bt=({visible:r,onClose:i,logsData:a,loading:o,onDownloadPDF:s,onDownloadExcel:n})=>{var m,_,C,h,y;const[f,l]=x.useState(null);return e.jsxs(e.Fragment,{children:[e.jsxs(H,{visible:r,onClose:i,size:"xl",backdrop:"static",children:[e.jsx(Z,{onClose:i,children:e.jsx(Y,{children:"Payment Logs"})}),e.jsx(K,{children:o?e.jsxs("div",{className:"text-center py-5",children:[e.jsx(le,{}),e.jsx("p",{children:"Loading..."})]}):a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"d-flex justify-content-end gap-2 mb-3",children:[e.jsxs(w,{color:"primary",onClick:s,children:[e.jsx(M,{icon:De})," PDF"]}),e.jsxs(w,{color:"success",onClick:n,children:[e.jsx(M,{icon:Ie})," Excel"]})]}),e.jsxs(Ae,{className:"mb-4",children:[e.jsx(Le,{children:"Summary"}),e.jsx(Be,{children:e.jsxs(I,{children:[e.jsxs(g,{children:[e.jsx("strong",{children:"Vendor:"})," ",(m=a.vendor_details)==null?void 0:m.vendor_name]}),e.jsxs(g,{children:[e.jsx("strong",{children:"Total:"})," ₹",parseFloat(((_=a.payment_master)==null?void 0:_.total_amount)||0).toFixed(2)]}),e.jsxs(g,{children:[e.jsx("strong",{children:"Paid:"})," ₹",parseFloat(((C=a.payment_master)==null?void 0:C.paid_amount)||0).toFixed(2)]}),e.jsxs(g,{children:[e.jsx("strong",{children:"Balance:"})," ₹",parseFloat(((h=a.payment_master)==null?void 0:h.balance_amount)||0).toFixed(2)]})]})})]}),e.jsxs(Ee,{striped:!0,bordered:!0,hover:!0,children:[e.jsx($e,{color:"dark",children:e.jsxs(X,{children:[e.jsx(S,{children:"#"}),e.jsx(S,{children:"Paid By"}),e.jsx(S,{children:"Type"}),e.jsx(S,{children:"Amount"}),e.jsx(S,{children:"Date"}),e.jsx(S,{children:"Description"}),e.jsx(S,{children:"Bank Name"}),e.jsx(S,{children:"A/C No"}),e.jsx(S,{children:"IFSC"}),e.jsx(S,{children:"Transaction ID / UTR"}),e.jsx(S,{children:"File"})]})}),e.jsx(Me,{children:(y=a.payment_logs)==null?void 0:y.map((d,b)=>e.jsxs(X,{children:[e.jsx(P,{children:b+1}),e.jsx(P,{children:d.paid_by}),e.jsx(P,{children:e.jsx(ie,{color:d.payment_type==="Cash"?"success":"info",children:d.payment_type})}),e.jsxs(P,{children:["₹",parseFloat(d.amount).toFixed(2)]}),e.jsx(P,{children:new Date(d.payment_date).toLocaleDateString()}),e.jsx(P,{children:d.description||"-"}),e.jsx(P,{children:d.bank_name||"-"}),e.jsx(P,{children:d.acc_number||"-"}),e.jsx(P,{children:d.ifsc||"-"}),e.jsx(P,{children:d.transaction_id||"-"}),e.jsx(P,{children:d.payment_file?e.jsx(w,{size:"sm",color:"info",onClick:()=>l(d.payment_file),children:"View"}):e.jsx(ie,{color:"secondary",children:"No File"})})]},d.id))})]})]}):e.jsx(oe,{color:"info",children:"No payment logs found."})}),e.jsx(Q,{children:e.jsx(w,{color:"secondary",onClick:i,children:"Close"})})]}),e.jsxs(H,{visible:!!f,onClose:()=>l(null),size:"lg",children:[e.jsx(Z,{children:e.jsx(Y,{children:"View File"})}),e.jsx(K,{children:f?(()=>{const d=f.split("/").pop(),b=f.startsWith("img/")?f:"img/"+f,v=nt+b,T=d.split(".").pop().toLowerCase();return T==="pdf"?e.jsx("iframe",{src:v,title:"PDF Preview",style:{width:"100%",height:"70vh",border:"none"}}):["jpg","jpeg","png"].includes(T)?e.jsx("img",{src:v,alt:"File",style:{maxWidth:"100%",maxHeight:"70vh",display:"block",margin:"auto",borderRadius:"10px"}}):e.jsx("p",{style:{color:"red",textAlign:"center"},children:"Unsupported file type"})})():e.jsx("p",{style:{color:"red",textAlign:"center"},children:"File not available"})}),e.jsx(Q,{children:e.jsx(w,{color:"secondary",onClick:()=>l(null),children:"Close"})})]})]})},vt=(r,i)=>{const a=new ce;a.setFontSize(22).setFont(void 0,"bold").text("Purchase Vendor Payments Report",14,20),a.setFontSize(14).setFont(void 0,"normal").text(`Project: ${i}`,14,32),a.setFontSize(12).text(`Generated on: ${new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}`,14,42);const o=["Vendor Name","Total","Paid","Balance","Status","Created"],s=[];let n=0,f=0,l=0;r.forEach(m=>{var b,v;const _=parseFloat(m.amount),C=parseFloat(m.paid_amount),h=parseFloat(m.balance_amount),y=C/_,d=y===0?"Unpaid":y===1?"Paid":"Partial";n+=_,f+=C,l+=h,s.push([((v=(b=m==null?void 0:m.purchase)==null?void 0:b.vendor)==null?void 0:v.name)||"-",_.toFixed(2),C.toFixed(2),h.toFixed(2),d,new Date(m.created_at).toLocaleDateString("en-GB")])}),s.push(["Total:",n.toFixed(2),f.toFixed(2),l.toFixed(2),"",""]),a.autoTable({head:[o],body:s,startY:52,theme:"grid",styles:{fontSize:10,cellPadding:4,lineColor:[44,62,80],lineWidth:.1},headStyles:{fillColor:[52,152,219],textColor:[255,255,255],fontStyle:"bold",halign:"center",fontSize:11},columnStyles:{0:{cellWidth:45,halign:"left"},1:{cellWidth:28,halign:"right"},2:{cellWidth:28,halign:"right"},3:{cellWidth:28,halign:"right"},4:{cellWidth:25,halign:"center"},5:{cellWidth:30,halign:"center"}},alternateRowStyles:{fillColor:[245,245,245]},didParseCell:m=>{m.row.index===s.length-1&&(m.cell.styles.fontStyle="bold",m.cell.styles.fillColor=[220,230,241])}}),a.save(`vendor-payments-${i.replace(/\s+/g,"-")}-${Date.now()}.pdf`)},Ft=(r,i)=>{let a=0,o=0,s=0;const n=r.map(h=>{var p,$;const y=parseFloat(h.amount),d=parseFloat(h.paid_amount),b=parseFloat(h.balance_amount),v=d/y,T=v===0?"Unpaid":v===1?"Paid":"Partial";return a+=y,o+=d,s+=b,{"Vendor Name":(($=(p=h==null?void 0:h.purchase)==null?void 0:p.vendor)==null?void 0:$.name)||"-",Total:y.toFixed(2),Paid:d.toFixed(2),Balance:b.toFixed(2),Status:T,Created:new Date(h.created_at).toLocaleDateString("en-GB")}});n.push({"Vendor Name":"Total:",Total:a.toFixed(2),Paid:o.toFixed(2),Balance:s.toFixed(2),Status:"",Created:""});const f=L.book_new(),l=L.aoa_to_sheet([]),m=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});L.sheet_add_aoa(l,[["Purchase Vendor Payments Report"],[`Project: ${i}`],[`Generated on: ${m}`],[]],{origin:"A1"}),L.sheet_add_json(l,n,{origin:"A5",skipHeader:!1});const _=["A","B","C","D","E","F"];_.forEach(h=>{const y=`${h}5`;l[y]&&(l[y].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"3498DB"}},alignment:{horizontal:"center"}})});const C=4+n.length+1;_.forEach(h=>{const y=l[`${h}${C}`];y&&(y.s={font:{bold:!0},fill:{fgColor:{rgb:"DCE6F1"}},alignment:{horizontal:h==="A"?"left":"right"}})}),l["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:15},{wch:12},{wch:18}],l["!merges"]=[{s:{r:0,c:0},e:{r:0,c:5}},{s:{r:1,c:0},e:{r:1,c:5}},{s:{r:2,c:0},e:{r:2,c:5}}],L.book_append_sheet(f,l,"Payments"),de(f,`vendor-payments-${i.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},wt=(r,i)=>{const a=new ce("landscape");a.setFontSize(18).setFont("helvetica","bold").text("All Vendor Payment Logs",14,15),a.setFontSize(12).setFont("helvetica","normal").text(`Project: ${i}`,14,23),a.setFontSize(10).text(`Generated: ${new Date().toLocaleString("en-GB")}`,14,30);const o=[];let s=0,n=0,f=0;r.forEach(l=>{var d,b,v,T;const m=((b=(d=l.purchase)==null?void 0:d.vendor)==null?void 0:b.name)||"Unknown",_=((v=l.purchase)==null?void 0:v.material_name)||"-",C=parseFloat(l.amount),h=parseFloat(l.paid_amount),y=parseFloat(l.balance_amount);s+=C,n+=h,f+=y,o.push([{content:`Vendor: ${m} | Material: ${_}`,colSpan:6,styles:{fontStyle:"bold",fillColor:[230,240,255],fontSize:11,textColor:[20,40,90]}},{content:C.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:h.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:y.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:y===0?[220,255,220]:[255,230,230]}}]),((T=l.logs)==null?void 0:T.length)>0?l.logs.forEach((p,$)=>{var D;o.push([$+1,p.paid_by||"-",p.payment_type||"-",parseFloat(p.amount).toFixed(2),new Date(p.payment_date).toLocaleDateString("en-GB"),(p.description||"-").substring(0,40)+(((D=p.description)==null?void 0:D.length)>40?"...":""),"","",""])}):o.push([{content:"No payments yet",colSpan:6,styles:{fontStyle:"italic",textColor:[150,150,150]}},"","",""]),o.push(["","","","","","","","",""])}),o.push([{content:"GRAND TOTAL",colSpan:6,styles:{fontStyle:"bold",fillColor:[200,230,200],fontSize:11}},{content:s.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:n.toFixed(2),styles:{fontStyle:"bold",halign:"right"}},{content:f.toFixed(2),styles:{fontStyle:"bold",halign:"right",fillColor:f===0?[180,255,180]:[255,180,180]}}]),a.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description","Total","Paid","Balance"]],body:o,startY:35,theme:"grid",styles:{fontSize:8.5,cellPadding:2.5,lineColor:[180,180,180],lineWidth:.1},headStyles:{fillColor:[30,100,180],textColor:255,fontStyle:"bold",fontSize:9},columnStyles:{0:{cellWidth:12},1:{cellWidth:32},2:{cellWidth:22},3:{cellWidth:24},4:{cellWidth:26},5:{cellWidth:78},6:{cellWidth:28,halign:"right"},7:{cellWidth:28,halign:"right"},8:{cellWidth:28,halign:"right"}},margin:{top:35,left:8,right:8}}),a.save(`All_Logs_${i.replace(/[^a-zA-Z0-9]/g,"_")}_${Date.now()}.pdf`)},Ct=(r,i)=>{const a=[];let o=0,s=0,n=0;r.forEach(_=>{var v,T,p,$;const C=((T=(v=_.purchase)==null?void 0:v.vendor)==null?void 0:T.name)||"Unknown",h=((p=_.purchase)==null?void 0:p.material_name)||"-",y=parseFloat(_.amount),d=parseFloat(_.paid_amount),b=parseFloat(_.balance_amount);o+=y,s+=d,n+=b,a.push({"Vendor → Material":`${C} → ${h}`,"#":"","Paid By":"",Type:"",Amount:"","Payment Date":"",Description:"",Total:y.toFixed(2),Paid:d.toFixed(2),Balance:b.toFixed(2)}),(($=_.logs)==null?void 0:$.length)>0?_.logs.forEach((D,J)=>{a.push({"Vendor → Material":"","#":J+1,"Paid By":D.paid_by||"-",Type:D.payment_type||"-",Amount:parseFloat(D.amount).toFixed(2),"Payment Date":new Date(D.payment_date).toLocaleDateString("en-GB"),Description:D.description||"-",Total:"",Paid:"",Balance:""})}):a.push({"Vendor → Material":"","#":"","Paid By":"No payments yet",Total:"",Paid:"",Balance:""}),a.push({})}),a.push({"Vendor → Material":"GRAND TOTAL",Total:o.toFixed(2),Paid:s.toFixed(2),Balance:n.toFixed(2)});const f=L.book_new(),l=L.aoa_to_sheet([]),m=new Date().toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});L.sheet_add_aoa(l,[["All Vendor Payment Logs (Detailed)"],[`Project: ${i}`],[`Generated on: ${m}`],[]],{origin:"A1"}),L.sheet_add_json(l,a,{origin:"A5",skipHeader:!1}),l["!cols"]=[{wch:40},{wch:8},{wch:25},{wch:15},{wch:15},{wch:18},{wch:35},{wch:15},{wch:15},{wch:15}],l["!merges"]=[{s:{r:0,c:0},e:{r:0,c:9}},{s:{r:1,c:0},e:{r:1,c:9}},{s:{r:2,c:0},e:{r:2,c:9}}],L.book_append_sheet(f,l,"All Payment Logs"),de(f,`all-payment-logs-${i.replace(/\s+/g,"-")}-${Date.now()}.xlsx`)},St=r=>{const i=new ce("landscape");i.setFontSize(18).text("Vendor Payment Report",14,15),i.setFontSize(12).text(`Project: ${r.vendor_details.project.project_name}`,14,25),i.setFontSize(10).text(`Generated: ${new Date().toLocaleString()}`,14,32);const a=[[`Vendor: ${r.vendor_details.vendor_name}`,`Material: ${r.vendor_details.material_name}`,`Total: ${r.payment_master.total_amount}`,`Paid: ${r.payment_master.paid_amount}`,`Balance: ${r.payment_master.balance_amount}`]];i.autoTable({body:a,startY:40,theme:"plain",columnStyles:{0:{cellWidth:70},1:{cellWidth:70},2:{cellWidth:35},3:{cellWidth:35},4:{cellWidth:35}}});const o=r.payment_logs.map((s,n)=>[n+1,s.paid_by,s.payment_type,Number(s.amount).toFixed(2),new Date(s.payment_date).toLocaleDateString("en-GB"),s.description||"-"]);i.autoTable({head:[["No.","Paid By","Type","Amount","Date","Description"]],body:o,startY:i.lastAutoTable.finalY+10,headStyles:{fillColor:[0,72,144],textColor:"#fff"},alternateRowStyles:{fillColor:[240,248,255]}}),i.save(`Vendor_Payment_${r.vendor_details.vendor_name.replace(/\s+/g,"_")}.pdf`)},Pt=r=>{const i=[];i.push(["Vendor Payment Report"],[],[`Project: ${r.vendor_details.project.project_name}`],[`Generated: ${new Date().toLocaleString()}`],[]),i.push([`Vendor: ${r.vendor_details.vendor_name}`,`Material: ${r.vendor_details.material_name}`,`Total: ${r.payment_master.total_amount}`,`Paid: ${r.payment_master.paid_amount}`,`Balance: ${r.payment_master.balance_amount}`]),i.push([],["No.","Paid By","Type","Amount","Date","Description"]),r.payment_logs.forEach((s,n)=>{i.push([n+1,s.paid_by,s.payment_type,Number(s.amount).toFixed(2),new Date(s.payment_date).toLocaleDateString("en-GB"),s.description||"-"])});const a=L.aoa_to_sheet(i);a["!cols"]=[{wch:8},{wch:20},{wch:15},{wch:15},{wch:15},{wch:40}];const o=L.book_new();L.book_append_sheet(o,a,"Vendor Logs"),de(o,`Vendor_Payment_${r.vendor_details.vendor_name.replace(/\s+/g,"_")}.xlsx`)},ra=()=>{const[r,i]=x.useState(""),[a,o]=x.useState(""),[s,n]=x.useState([]),[f,l]=x.useState([]),[m,_]=x.useState(!1),[C,h]=x.useState([]),[y,d]=x.useState(!1),b=x.useRef(null),v=x.useRef(null),[T,p]=x.useState(!1),[$,D]=x.useState(!1),[J,me]=x.useState(!1),[ze,ee]=x.useState(!1),[z,Ve]=x.useState(null),[te,he]=x.useState(null),[qe,pe]=x.useState(!1),[ae,ue]=x.useState(!1),[kt,xe]=x.useState(null),[k,re]=x.useState({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:"",project_id:"",payment_id:null}),[We,U]=x.useState(""),[u,G]=x.useState({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""}),[Re,A]=x.useState(""),[Ue,ye]=x.useState(!1),{showToast:W}=rt(),Ge=async()=>{try{const t=await O("/api/getPurchesVendor");l(t||[])}catch{W("danger","Failed to load vendors")}},ne=async()=>{if(r){_(!0);try{const t=await O(`/api/getPurchesVedorPayment?project_id=${r}`);t&&t.success&&Array.isArray(t.data)?n(t.data):n([])}catch{W("danger","Failed to load payments"),n([])}finally{_(!1)}}},Oe=async t=>{pe(!0);try{const c=await O(`/api/getVendorPaymentDetails/${t}`);he(c)}catch{W("danger","Failed to load payment logs"),he(null)}finally{pe(!1)}},He=async t=>{var B,V,q,R,ge,be,ve,Fe,we;if(A(""),!u.paid_by.trim())return A("Paid by is required");if(!u.payment_type.trim())return A("Payment type is required");if(!u.amount||u.amount<=0)return A("Amount must be > 0");if(!u.payment_date)return A("Payment date is required");if(Number(u.amount)>Number(z==null?void 0:z.balance_amount))return A(`Amount cannot be more than pending balance ₹${z==null?void 0:z.balance_amount}`);const c=["imps","neft","rtgs"].includes(u.payment_type.toLowerCase()),E=u.payment_type.toLowerCase()==="upi";if(c){if(!((B=u.bank_name)!=null&&B.trim()))return A("Bank name is required");if(!((V=u.acc_number)!=null&&V.trim()))return A("Account number is required");if(!((q=u.ifsc)!=null&&q.trim()))return A("IFSC code is required");if(!((R=u.transaction_id)!=null&&R.trim()))return A("Transaction ID is required")}if(E&&!((ge=u.transaction_id)!=null&&ge.trim()))return A("UPI Transaction ID is required");if(t==="upload"&&!u.payment_file)return A("Payment file is required");const j=new FormData;j.append("purches_vendor_id",u.purches_vendor_id),j.append("paid_by",u.paid_by),j.append("payment_type",u.payment_type),j.append("amount",parseFloat(u.amount)),j.append("payment_date",u.payment_date),(be=u.description)!=null&&be.trim()&&j.append("description",u.description),(ve=u.remark)!=null&&ve.trim()&&j.append("remark",u.remark),u.payment_file&&j.append("payment_file",u.payment_file),j.append("bank_name",u.bank_name||""),j.append("acc_number",u.acc_number||""),j.append("ifsc",u.ifsc||""),j.append("transaction_id",u.transaction_id||""),ye(!0);try{const se=await st("/api/addVendorPayment",j);W("success",se.message||"Payment added successfully!"),p(!1),Je(),ne()}catch(se){const at=((we=(Fe=se.response)==null?void 0:Fe.data)==null?void 0:we.message)||"Payment failed";A(at)}finally{ye(!1)}},je=x.useCallback(async t=>{if(!t.trim()){h([]);return}try{const c=await O(`/api/projects?searchQuery=${t}`);h(c||[])}catch{h([])}},[]);x.useEffect(()=>{const t=setTimeout(()=>{a.length>2?je(a):(h([]),d(!1))},300);return()=>clearTimeout(t)},[a,je]),x.useEffect(()=>{const t=c=>{b.current&&!b.current.contains(c.target)&&d(!1)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]),x.useEffect(()=>{r?ne():n([])},[r]);const fe=t=>{o(t.project_name),i(t.id),h([]),d(!1),v.current&&v.current.blur()},_e=()=>{ue(!1),xe(null),re({vendor_id:"",material_name:"",about:"",qty:"",price:"",total:0,date:new Date().toISOString().split("T")[0],project_id:r,payment_id:null}),U(""),D(!0)},Ze=t=>{ue(!0),xe(t.id);const c=t.purchase||{};re({vendor_id:c.vendor_id||"",material_name:c.material_name||"",about:c.about||"",qty:parseFloat(c.qty)||"",price:parseFloat(c.price_per_unit)||"",total:parseFloat(c.total)||0,date:c.date||new Date().toISOString().split("T")[0],project_id:r,payment_id:t.id}),U(""),D(!0)},Ye=t=>{const{name:c,value:E}=t.target;re(j=>{const B={...j,[c]:E};if(c==="qty"||c==="price"){const V=c==="qty"?parseFloat(E)||0:parseFloat(j.qty)||0,q=c==="price"?parseFloat(E)||0:parseFloat(j.price)||0;B.total=(V*q).toFixed(2)}return B})},Ke=()=>k.vendor_id?k.material_name.trim()?!k.qty||k.qty<=0?"Qty must be > 0":!k.price||k.price<=0?"Price must be > 0":k.date?"":"Date is required":"Material name is required":"Vendor is required",Qe=async()=>{var E,j;const t=Ke();if(t)return U(t);const c={project_id:parseInt(r),vendor_id:parseInt(k.vendor_id),material_name:k.material_name,about:k.about||null,price_per_unit:parseFloat(k.price),qty:parseFloat(k.qty),total:parseFloat(k.total),date:k.date};try{ae?await it("/api/updatePurchesVendorPayment",{...c,payment_id:k.payment_id}):await lt("/api/purchesVendor",c),W("success",ae?"Updated successfully!":"Added successfully!"),D(!1),ne()}catch(B){U(((j=(E=B.response)==null?void 0:E.data)==null?void 0:j.message)||"Operation failed")}},Xe=t=>{Ve(t),G({purches_vendor_id:t.purches_vendor_id,paid_by:"",payment_type:"",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""}),A(""),p(!0)},Je=()=>{G({purches_vendor_id:"",paid_by:"Admin",payment_type:"Cash",amount:"",payment_date:new Date().toISOString().split("T")[0],description:"",remark:"",payment_file:null,bank_name:"",acc_number:"",ifsc:"",transaction_id:""})},et=t=>{const{name:c,value:E,files:j}=t.target;c==="payment_file"&&j&&j[0]?G(B=>({...B,payment_file:j[0]})):G(B=>({...B,[c]:E}))},tt=async t=>{me(!0),await Oe(t)};return x.useEffect(()=>{Ge()},[]),e.jsxs(e.Fragment,{children:[e.jsxs(Ae,{className:"mb-4",children:[e.jsxs(Le,{className:"bg-primary text-white d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:"Purchase Vendor Payments"}),e.jsxs("div",{children:[r&&s.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(w,{size:"sm",color:"light",className:"me-2",onClick:()=>vt(s,a),children:[e.jsx(M,{icon:De})," PDF"]}),e.jsxs(w,{size:"sm",color:"light",className:"me-2",onClick:()=>Ft(s,a),children:[e.jsx(M,{icon:Ie})," Excel"]})]}),s.some(t=>{var c;return((c=t.logs)==null?void 0:c.length)>0})&&e.jsxs(e.Fragment,{children:[e.jsx(w,{size:"sm",color:"light",className:"me-2",onClick:()=>wt(s,a),children:"All Logs PDF"}),e.jsx(w,{size:"sm",color:"light",onClick:()=>Ct(s,a),children:"All Logs Excel"})]})]})]}),e.jsxs(Be,{children:[e.jsx(I,{className:"mb-4",children:e.jsx(g,{md:12,children:e.jsxs("div",{className:"position-relative",ref:b,children:[e.jsxs(ut,{children:[e.jsx(N,{ref:v,type:"text",placeholder:"Search and select project...",value:a,onChange:t=>{o(t.target.value),r&&t.target.value!==a&&i("")},onFocus:()=>C.length>0&&d(!0),autoComplete:"off"}),r?e.jsx(w,{color:"danger",variant:"outline",onClick:()=>{o(""),i(""),n([])},children:e.jsx(M,{icon:yt})}):e.jsx(w,{color:"primary",variant:"outline",onClick:()=>ee(!0),children:e.jsx(M,{icon:xt})})]}),y&&C.length>0&&e.jsx("div",{className:"border bg-white shadow-sm rounded",style:{position:"absolute",top:"100%",left:0,right:0,maxHeight:"200px",overflowY:"auto",zIndex:1e3,marginTop:"2px"},children:C.map(t=>e.jsx("div",{className:"px-3 py-2 hover-bg-light cursor-pointer",style:{cursor:"pointer"},onClick:()=>fe(t),children:t.project_name},t.id))}),r&&e.jsxs("small",{className:"text-success d-block mt-1",children:["Selected: ",e.jsx("strong",{children:a})]})]})})}),m?e.jsx("div",{className:"text-center py-4",children:e.jsx(le,{})}):s.length>0?e.jsx("div",{className:"table-responsive",children:e.jsxs(Ee,{striped:!0,hover:!0,children:[e.jsx($e,{color:"light",children:e.jsxs(X,{children:[e.jsx(S,{children:"Vendor Name"}),e.jsx(S,{children:"Total"}),e.jsx(S,{children:"Paid"}),e.jsx(S,{children:"Balance"}),e.jsx(S,{children:"Status"}),e.jsx(S,{children:"Created"}),e.jsx(S,{children:"Actions"})]})}),e.jsx(Me,{children:s.map(t=>{var V,q,R;const c=parseFloat(t.paid_amount)/parseFloat(t.amount)*100,E=c===0?"danger":c===100?"success":"warning",j=c===0?"Unpaid":c===100?"Paid":"Partial",B=parseFloat(t.balance_amount)>0;return e.jsxs(X,{children:[e.jsx(P,{children:(q=(V=t==null?void 0:t.purchase)==null?void 0:V.vendor)==null?void 0:q.name}),e.jsxs(P,{children:["₹",parseFloat(t.amount).toFixed(2)]}),e.jsxs(P,{children:["₹",parseFloat(t.paid_amount).toFixed(2)]}),e.jsxs(P,{children:["₹",parseFloat(t.balance_amount).toFixed(2)]}),e.jsx(P,{children:e.jsx(ie,{color:E,children:j})}),e.jsx(P,{children:new Date(t.created_at).toLocaleDateString()}),e.jsxs(P,{children:[e.jsxs(w,{color:"info",size:"sm",className:"me-1",onClick:()=>tt(t.purches_vendor_id),disabled:!t.logs||t.logs.length===0,children:[e.jsx(M,{icon:ft})," Logs (",((R=t.logs)==null?void 0:R.length)||0,")"]}),e.jsxs(w,{color:"success",size:"sm",className:"me-1",onClick:()=>Xe(t),disabled:!B,title:B?"Make Payment":"Fully Paid",children:[e.jsx(M,{icon:pt})," Pay"]}),e.jsx(w,{color:"warning",size:"sm",className:"me-1",onClick:()=>Ze(t),children:e.jsx(M,{icon:jt})})]})]},t.id)})})]})}):r?e.jsxs("div",{className:"text-center py-5",children:[e.jsx("h5",{className:"text-muted",children:"No payments yet"}),e.jsxs(w,{color:"primary",onClick:_e,children:[e.jsx(M,{icon:Ne,className:"me-1"}),"Add First Material"]})]}):e.jsx("div",{className:"text-center py-5",children:e.jsx("h5",{className:"text-muted",children:"Select a project to view payments"})}),r&&!m&&e.jsx("div",{className:"mt-3",children:e.jsxs(w,{color:"success",onClick:_e,children:[e.jsx(M,{icon:Ne,className:"me-1"}),"Add Material"]})})]})]}),e.jsx(_t,{visible:T,onClose:()=>p(!1),payForm:u,payError:Re,payLoading:Ue,onChange:et,onSubmit:He,selectedVendorPayment:z}),e.jsx(gt,{visible:$,onClose:()=>D(!1),isEdit:ae,form:k,vendors:f,onChange:Ye,onSubmit:Qe,error:We}),e.jsx(bt,{visible:J,onClose:()=>me(!1),logsData:te,loading:qe,onDownloadPDF:()=>St(te),onDownloadExcel:()=>Pt(te)}),e.jsx(ot,{visible:ze,onClose:()=>ee(!1),onSelectProject:t=>{fe(t),ee(!1)}})]})};export{ra as default};
