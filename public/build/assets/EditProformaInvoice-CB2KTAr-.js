import{d as be,u as Ce,b as Pe,r as d,j as e,C as ee}from"./index-D77JVx93.js";import{a as y,b as o,c as P}from"./index.esm-CnYARBHd.js";import{a as te,b as Ae}from"./api-C2dAnRUz.js";import{C as z,a as B}from"./CCardBody-CmpV1lA4.js";import{C as Ne}from"./cil-mobile-CeKkmNgt.js";import{C as h}from"./CButton-1GsZ7-l4.js";import{C as Se}from"./CCardHeader-CTLciU6o.js";import{c as Fe}from"./cil-arrow-left-D66Kb3Zq.js";import{C as ke}from"./CForm-CvVYu-wE.js";import{C as l}from"./CFormLabel-Dc8HuNh9.js";import{C as m}from"./CFormInput-l8xIFq1a.js";import{C as Te}from"./CFormSelect-BEYL04sy.js";import{C as x}from"./CInputGroup-iSurCesp.js";import{C as f}from"./CInputGroupText-BPolkdL-.js";import{C as se}from"./DefaultLayout-B9m2Op0L.js";import{c as re}from"./cil-pencil-m516yCOw.js";import{c as ne}from"./cil-x-0440B5Ce.js";import{C as we}from"./CFormTextarea-BeYCqixl.js";import{c as qe}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-Bm4xoNnJ.js";import"./RawMaterial-BtjEDAbB.js";const tt=()=>{var K,Y,Z;const{id:v}=be(),A=Ce(),{showToast:I}=Pe(),[ae,V]=d.useState(!0),[G,L]=d.useState(!1),[oe,ce]=d.useState(!1),[Ie,ie]=d.useState([]),[le,me]=d.useState([]),[b,de]=d.useState(null),[i,E]=d.useState({tally_invoice_number:"",invoice_date:"",delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",status:"draft",terms_conditions:"",payment_terms:""}),[_,k]=d.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}]),[N,T]=d.useState([]),[ue,D]=d.useState(-1),[$,U]=d.useState(""),[R,M]=d.useState(""),[S,w]=d.useState([]),[pe,W]=d.useState(-1),[Q,H]=d.useState(""),[O,X]=d.useState("");d.useEffect(()=>{ge(),xe()},[v]);const ge=async()=>{var s,r;try{V(!0);const n=await te(`/api/proforma-invoices/${v}`);if(n&&n.success&&n.data){const t=n.data;de(t),E({tally_invoice_number:t.tally_invoice_number||"",invoice_date:((s=t.invoice_date)==null?void 0:s.split("T")[0])||"",delivery_date:((r=t.delivery_date)==null?void 0:r.split("T")[0])||"",discount:parseFloat(t.discount)||0,subtotal:parseFloat(t.subtotal)||0,taxableAmount:parseFloat(t.taxable_amount)||0,gstAmount:parseFloat(t.gst_amount)||0,sgstAmount:parseFloat(t.sgst_amount)||0,cgstAmount:parseFloat(t.cgst_amount)||0,igstAmount:parseFloat(t.igst_amount)||0,finalAmount:parseFloat(t.final_amount)||0,gstPercentage:parseFloat(t.gst_percentage)||18,sgstPercentage:parseFloat(t.sgst_percentage)||9,cgstPercentage:parseFloat(t.cgst_percentage)||9,igstPercentage:parseFloat(t.igst_percentage)||0,notes:t.notes||"",status:t.status||"draft",terms_conditions:t.terms_conditions||"",payment_terms:t.payment_terms||""}),t.details&&t.details.length>0&&k(t.details.map(a=>({work_type:a.work_type||"",uom:a.uom||"",qty:parseFloat(a.qty)||0,price:parseFloat(a.price)||0,total_price:parseFloat(a.total_price)||0,gst_percent:parseFloat(a.gst_percent)||18,cgst_amount:parseFloat(a.cgst_amount)||0,sgst_amount:parseFloat(a.sgst_amount)||0,remark:a.remark||""}))),t.payment_terms&&T(t.payment_terms.split(`
`).filter(a=>a.trim())),t.terms_conditions&&w(t.terms_conditions.split(`
`).filter(a=>a.trim())),t.invoice_rules&&t.invoice_rules.length>0&&me(t.invoice_rules.map(a=>a.rules_id))}}catch(n){console.error("Error fetching proforma invoice:",n),I("danger","Failed to load proforma invoice"),setTimeout(()=>A("/invoiceTable"),2e3)}finally{V(!1)}},xe=async()=>{try{const s=await te("/api/rules");ie(Array.isArray(s)?s:[])}catch(s){console.error("Error fetching rules:",s)}},j=s=>{const{name:r,value:n}=s.target;E(t=>{let a={...t,[r]:r==="discount"||r.endsWith("Percentage")?parseFloat(n)||0:n};if(r==="gstPercentage"){const c=(parseFloat(n)||0)/2;a={...a,sgstPercentage:c,cgstPercentage:c}}else if(r==="sgstPercentage"||r==="cgstPercentage"){const u=r==="sgstPercentage"?parseFloat(n)||0:t.sgstPercentage,c=r==="cgstPercentage"?parseFloat(n)||0:t.cgstPercentage;a={...a,gstPercentage:u+c}}if(r==="discount"||r.endsWith("Percentage")){const u=_.reduce((_e,ve)=>_e+(ve.total_price||0),0),c=u-a.discount,p=c*(a.sgstPercentage/100),g=c*(a.cgstPercentage/100),F=c*(a.igstPercentage/100),q=p+g+F,fe=c+q;a={...a,subtotal:u,taxableAmount:c,gstAmount:q,sgstAmount:p,cgstAmount:g,igstAmount:F,finalAmount:fe}}return a})},C=(s,r,n)=>{const t=[..._];r==="qty"||r==="price"||r==="gst_percent"?t[s][r]=parseFloat(n)||0:t[s][r]=n;const a=t[s].qty||0,u=t[s].price||0,c=t[s].gst_percent||0,p=a*u,g=p*(c/2/100),F=p*(c/2/100),q=p+g+F;t[s].total_price=q,t[s].cgst_amount=g,t[s].sgst_amount=F,k(t),J(t)},he=()=>{k([..._,{work_type:"",uom:"",qty:0,price:0,total_price:0,gst_percent:18,cgst_amount:0,sgst_amount:0,remark:""}])},je=s=>{if(_.length===1)return;const r=[..._];r.splice(s,1),k(r),J(r)},J=s=>{E(r=>{const n=s.reduce((p,g)=>p+g.qty*g.price,0),t=s.reduce((p,g)=>p+(g.cgst_amount||0),0),a=s.reduce((p,g)=>p+(g.sgst_amount||0),0),u=t+a,c=s.reduce((p,g)=>p+(g.total_price||0),0);return{...r,subtotal:n,taxableAmount:n,gstAmount:u,cgstAmount:t,sgstAmount:a,igstAmount:0,finalAmount:c-(r.discount||0)}})},ye=async s=>{var n,t;if(s.preventDefault(),!s.currentTarget.checkValidity()){ce(!0);return}try{L(!0);const a={tally_invoice_number:i.tally_invoice_number||null,invoice_date:i.invoice_date,delivery_date:i.delivery_date||null,items:_.filter(c=>c.work_type&&c.qty>0).map(c=>({work_type:c.work_type,uom:c.uom,qty:c.qty,price:c.price,total_price:c.total_price,remark:c.remark||"",gst_percent:c.gst_percent,cgst_amount:c.cgst_amount,sgst_amount:c.sgst_amount})),discount:i.discount,gst_percentage:i.gstPercentage,cgst_percentage:i.cgstPercentage,sgst_percentage:i.sgstPercentage,igst_percentage:i.igstPercentage,rule_ids:le,notes:i.notes||null,status:i.status,terms_conditions:S.join(`
`)||null,payment_terms:N.join(`
`)||null},u=await Ae(`/api/proforma-invoices/${v}`,a);if(u&&u.success)I("success","Proforma invoice updated successfully"),setTimeout(()=>{A(`/proforma-invoice-details/${v}`)},1500);else throw new Error(u.message||"Failed to update proforma invoice")}catch(a){console.error("Update error:",a);const u=((t=(n=a.response)==null?void 0:n.data)==null?void 0:t.message)||"Failed to update proforma invoice";I("danger",u)}finally{L(!1)}};return ae?e.jsx(z,{children:e.jsxs(B,{className:"text-center py-5",children:[e.jsx(ee,{color:"primary"}),e.jsx("div",{className:"mt-3",children:"Loading proforma invoice..."})]})}):b?e.jsx(y,{children:e.jsx(o,{xs:12,children:e.jsxs(z,{className:"mb-4",children:[e.jsx(Se,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("strong",{children:["Edit Proforma Invoice #",b.proforma_invoice_number]}),e.jsxs(h,{color:"secondary",size:"sm",onClick:()=>A(`/proforma-invoice-details/${v}`),children:[e.jsx(P,{icon:Fe,className:"me-1"}),"Back to Details"]})]})}),e.jsxs(B,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(y,{children:[e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order #:"}),e.jsx("div",{children:e.jsx("strong",{children:(K=b.work_order)==null?void 0:K.invoice_number})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(Y=b.project)==null?void 0:Y.project_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(Z=b.customer)==null?void 0:Z.name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Payment Status:"}),e.jsx("div",{children:e.jsx("strong",{className:"text-capitalize",children:b.payment_status})})]})]})]}),e.jsxs(ke,{validated:oe,onSubmit:ye,children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Tally Invoice Number"}),e.jsx(m,{type:"text",name:"tally_invoice_number",value:i.tally_invoice_number,onChange:j,placeholder:"Optional"})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Invoice Date *"}),e.jsx(m,{type:"date",name:"invoice_date",value:i.invoice_date,onChange:j,required:!0})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Delivery Date"}),e.jsx(m,{type:"date",name:"delivery_date",value:i.delivery_date,onChange:j})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Status"}),e.jsxs(Te,{name:"status",value:i.status,onChange:j,children:[e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"sent",children:"Sent"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),_.map((s,r)=>e.jsxs(y,{className:"g-3 mb-3 align-items-end",children:[e.jsxs(o,{md:2,children:[e.jsx(l,{children:"Work Type *"}),e.jsx(m,{placeholder:"Work Type",value:s.work_type,onChange:n=>C(r,"work_type",n.target.value),required:!0})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"UOM"}),e.jsx(m,{placeholder:"Unit",value:s.uom,onChange:n=>C(r,"uom",n.target.value)})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"Qty"}),e.jsx(m,{type:"number",placeholder:"Qty",step:"0.01",min:"0",value:s.qty,onChange:n=>C(r,"qty",n.target.value),required:!0})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"Rate"}),e.jsxs(x,{children:[e.jsx(f,{children:"₹"}),e.jsx(m,{type:"number",step:"0.01",min:"0",value:s.price,onChange:n=>C(r,"price",n.target.value),required:!0})]})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"Base Amt"}),e.jsxs("div",{className:"fw-medium",children:["₹",(s.qty*s.price).toFixed(2)]})]}),e.jsx(o,{md:1,children:e.jsx(m,{label:"GST %",type:"number",step:"0.01",min:"0",max:"100",value:s.gst_percent,onChange:n=>C(r,"gst_percent",n.target.value)})}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"CGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",s.cgst_amount.toFixed(2)]})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{children:"SGST"}),e.jsxs("div",{className:"text-success fw-medium",children:["₹",s.sgst_amount.toFixed(2)]})]}),e.jsxs(o,{md:1,children:[e.jsx(l,{className:"text-primary",children:"Total"}),e.jsxs("div",{className:"fw-bold text-primary",children:["₹",s.total_price.toFixed(2)]})]}),e.jsx(o,{md:1,children:e.jsx(m,{placeholder:"Remark",value:s.remark,onChange:n=>C(r,"remark",n.target.value)})}),e.jsx(o,{md:1,className:"d-flex align-items-end",children:e.jsx(h,{color:"danger",size:"sm",className:"w-100",onClick:()=>je(r),disabled:_.length===1,children:"×"})})]},r)),e.jsx(h,{color:"warning",variant:"outline",className:"mb-4",onClick:he,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Total GST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"gstPercentage",value:i.gstPercentage,onChange:j,min:"0",max:"100",step:"0.01"}),e.jsx(f,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",i.gstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"SGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"sgstPercentage",value:i.sgstPercentage,onChange:j,min:"0",max:"50",step:"0.01"}),e.jsx(f,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",i.sgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"CGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"cgstPercentage",value:i.cgstPercentage,onChange:j,min:"0",max:"50",step:"0.01"}),e.jsx(f,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",i.cgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"IGST (%)"}),e.jsxs(x,{children:[e.jsx(m,{type:"number",name:"igstPercentage",value:i.igstPercentage,onChange:j,min:"0",max:"100",step:"0.01"}),e.jsx(f,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",i.igstAmount.toFixed(2)]})]})]}),e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Subtotal"}),e.jsxs(x,{children:[e.jsx(f,{children:"₹"}),e.jsx(m,{type:"number",value:i.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Discount"}),e.jsxs(x,{children:[e.jsx(f,{children:"₹"}),e.jsx(m,{type:"number",name:"discount",value:i.discount,onChange:j,min:"0",step:"0.01"})]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Taxable Amount"}),e.jsxs(x,{children:[e.jsx(f,{children:"₹"}),e.jsx(m,{type:"number",value:i.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(l,{children:"Final Amount"}),e.jsxs(x,{children:[e.jsx(f,{children:"₹"}),e.jsx(m,{type:"number",value:i.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:N.map((s,r)=>ue===r?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(m,{value:$,onChange:n=>U(n.target.value)}),e.jsx(h,{color:"success",onClick:()=>{const n=[...N];n[r]=$.trim(),T(n),D(-1)},children:"Save"}),e.jsx(h,{color:"secondary",onClick:()=>D(-1),children:"Cancel"})]},r):e.jsxs(se,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(P,{icon:re,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{D(r),U(s)}}),e.jsx(P,{icon:ne,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{T(N.filter((n,t)=>t!==r))}})]},r))}),e.jsx(y,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(m,{placeholder:"Add new payment term...",value:R,onChange:s=>M(s.target.value)}),e.jsx(h,{color:"primary",onClick:()=>{R.trim()&&(T([...N,R.trim()]),M(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:S.map((s,r)=>pe===r?e.jsxs(x,{style:{width:"auto"},children:[e.jsx(m,{value:Q,onChange:n=>H(n.target.value)}),e.jsx(h,{color:"success",onClick:()=>{const n=[...S];n[r]=Q.trim(),w(n),W(-1)},children:"Save"}),e.jsx(h,{color:"secondary",onClick:()=>W(-1),children:"Cancel"})]},r):e.jsxs(se,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[s,e.jsx(P,{icon:re,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{W(r),H(s)}}),e.jsx(P,{icon:ne,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{w(S.filter((n,t)=>t!==r))}})]},r))}),e.jsx(y,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(x,{children:[e.jsx(m,{placeholder:"Add new condition...",value:O,onChange:s=>X(s.target.value)}),e.jsx(h,{color:"primary",onClick:()=>{O.trim()&&(w([...S,O.trim()]),X(""))},children:"Add"})]})})}),e.jsx(y,{className:"mb-3",children:e.jsxs(o,{md:12,children:[e.jsx(l,{children:"Additional Notes"}),e.jsx(we,{name:"notes",value:i.notes,onChange:j,rows:3,placeholder:"Enter any additional notes..."})]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsxs(h,{color:"primary",type:"submit",disabled:G,children:[G?e.jsx(ee,{size:"sm"}):e.jsx(P,{icon:qe,className:"me-1"}),"Update Proforma Invoice"]}),e.jsx(h,{color:"secondary",onClick:()=>A(`/proforma-invoice-details/${v}`),disabled:G,children:"Cancel"})]})]})]})]})})}):e.jsx(z,{children:e.jsx(B,{children:e.jsxs(Ne,{color:"danger",children:[e.jsx("h5",{children:"Proforma Invoice Not Found"}),e.jsx("p",{children:"The requested proforma invoice could not be found."}),e.jsx(h,{color:"primary",onClick:()=>A("/invoiceTable"),children:"Back to Orders"})]})})})};export{tt as default};
