import{e as je,u as pe,b as ye,r as d,j as e,C as fe}from"./index-C2h9iXsq.js";import{a as C,b as o,c as _}from"./index.esm-DQbyd5df.js";import{p as Ce}from"./api-C2dAnRUz.js";import{C as K,a as Y}from"./CCardBody-DHWC5_BS.js";import{C as be}from"./cil-mobile-CRjBRZgk.js";import{C as p}from"./CButton--W_4ZeJh.js";import{C as ve}from"./CCardHeader-BOYr8GAh.js";import{c as _e}from"./cil-arrow-left-D66Kb3Zq.js";import{C as ke}from"./CForm-BVvPNiqY.js";import{C as h}from"./CFormLabel-DkkhltaS.js";import{C as c}from"./CFormInput-Da28fgYD.js";import{C as g}from"./CInputGroup-DQyo9You.js";import{C as b}from"./CInputGroupText-UmKIgDi2.js";import{C as Z}from"./DefaultLayout-Bb3k2Kjc.js";import{c as ee}from"./cil-pencil-m516yCOw.js";import{c as te}from"./cil-x-0440B5Ce.js";import{C as Pe}from"./CFormTextarea-OofZxR1Z.js";import{c as we}from"./cil-save-CHBg7z_U.js";import"./CFormControlWrapper-CgtL4Ts4.js";import"./RawMaterial-BtjEDAbB.js";const Ue=()=>{var U,X,J;const se=je(),T=pe(),{showToast:k}=ye(),{workOrderId:D,workOrderData:m}=se.state||{},[L,z]=d.useState(!1),[re,ne]=d.useState(!1);d.useState([]);const[oe,Ae]=d.useState([]),[n,F]=d.useState({work_order_id:D||null,project_id:(m==null?void 0:m.project_id)||null,tally_invoice_number:"",invoice_date:new Date().toISOString().split("T")[0],delivery_date:"",discount:0,subtotal:0,taxableAmount:0,gstAmount:0,sgstAmount:0,cgstAmount:0,igstAmount:0,finalAmount:0,gstPercentage:18,sgstPercentage:9,cgstPercentage:9,igstPercentage:0,notes:"",terms_conditions:"",payment_terms:""}),[y,S]=d.useState([{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}]),ae=["25% Advance release on team mobilization onsite.","25% Release on completion of pile foundation.","20% Release after completion of MMS and Module mounting.","20% to be released on completion of AC/DC.","10% released after work has been completed and handed over to the client."],[P,q]=d.useState(ae),[ie,I]=d.useState(-1),[M,V]=d.useState(""),[W,$]=d.useState(""),ce=["18% Tax Extra","ROW on your side","Work will commence only after receiving an official work order"],[w,E]=d.useState(ce),[le,O]=d.useState(-1),[B,H]=d.useState(""),[R,Q]=d.useState("");d.useState(""),d.useEffect(()=>{if(m&&(F(r=>({...r,work_order_id:m.id,project_id:m.project_id})),m.items&&m.items.length>0)){const r=m.items.map(t=>({work_type:t.work_type||"",uom:t.uom||"",qty:t.qty||0,price:t.price||0,total_price:t.total_price||0,remark:t.remark||""}));S(r),G(r)}},[m]);const f=r=>{const{name:t,value:s}=r.target;F(a=>{let l={...a,[t]:t==="discount"||t.endsWith("Percentage")?parseFloat(s)||0:s};if(t==="gstPercentage"){const i=(parseFloat(s)||0)/2;l={...l,sgstPercentage:i,cgstPercentage:i}}else if(t==="sgstPercentage"||t==="cgstPercentage"){const j=t==="sgstPercentage"?parseFloat(s)||0:a.sgstPercentage,i=t==="cgstPercentage"?parseFloat(s)||0:a.cgstPercentage;l={...l,gstPercentage:j+i}}if(t==="discount"||t.endsWith("Percentage")){const j=y.reduce((ge,he)=>ge+(he.total_price||0),0),i=j-l.discount,x=i*(l.sgstPercentage/100),u=i*(l.cgstPercentage/100),v=i*(l.igstPercentage/100),N=x+u+v,xe=i+N;l={...l,subtotal:j,taxableAmount:i,gstAmount:N,sgstAmount:x,cgstAmount:u,igstAmount:v,finalAmount:xe}}return l})},A=(r,t,s)=>{const a=[...y];a[r][t]=t==="qty"||t==="price"?parseFloat(s)||0:s,a[r].total_price=(a[r].qty||0)*(a[r].price||0),S(a),G(a)},de=()=>{S([...y,{work_type:"",uom:"",qty:0,price:0,total_price:0,remark:""}])},me=r=>{const t=[...y];t.splice(r,1),S(t),G(t)},G=r=>{F(t=>{const s=r.reduce((v,N)=>v+(N.total_price||0),0),a=s-(t.discount||0),l=a*(t.sgstPercentage/100),j=a*(t.cgstPercentage/100),i=a*(t.igstPercentage/100),x=l+j+i,u=a+x;return{...t,subtotal:s,taxableAmount:a,gstAmount:x,sgstAmount:l,cgstAmount:j,igstAmount:i,finalAmount:u}})},ue=async r=>{var s,a,l,j;if(r.preventDefault(),!r.currentTarget.checkValidity()){ne(!0);return}if(!n.work_order_id||!n.project_id){k("danger","Work order and project information missing");return}if(y.length===0||y.every(i=>!i.work_type||i.qty<=0)){k("danger","Please add at least one valid work item");return}try{z(!0);const i={work_order_id:n.work_order_id,project_id:n.project_id,tally_invoice_number:n.tally_invoice_number||null,invoice_date:n.invoice_date,delivery_date:n.delivery_date||null,items:y.filter(u=>u.work_type&&u.qty>0),discount:n.discount,gst_percentage:n.gstPercentage,cgst_percentage:n.cgstPercentage,sgst_percentage:n.sgstPercentage,igst_percentage:n.igstPercentage,rule_ids:oe,notes:n.notes||null,payment_terms:P.join(`
`),terms_conditions:w.join(`
`)},x=await Ce("/api/proforma-invoices",i);if(x&&x.success)k("success","Proforma invoice created successfully"),setTimeout(()=>{T(`/proforma-invoice-details/${x.data.id}`)},1500);else throw new Error(x.message||"Failed to create proforma invoice")}catch(i){console.error("Submit error:",i);const x=((a=(s=i.response)==null?void 0:s.data)==null?void 0:a.message)||"Failed to create proforma invoice",u=(j=(l=i.response)==null?void 0:l.data)==null?void 0:j.data;if(u&&u.work_order_total!==void 0){const v=`

Work Order Total: ₹${u.work_order_total.toLocaleString()}
Already Allocated: ₹${u.already_allocated.toLocaleString()}
Remaining: ₹${u.remaining_amount.toLocaleString()}
Requested: ₹${u.requested_amount.toLocaleString()}`;k("danger",x+v,8e3)}else k("danger",x)}finally{z(!1)}};return!D||!m?e.jsx(K,{children:e.jsx(Y,{children:e.jsxs(be,{color:"warning",children:[e.jsx("h5",{children:"No Work Order Selected"}),e.jsx("p",{children:"Please select a work order to create a proforma invoice."}),e.jsx(p,{color:"primary",onClick:()=>T("/invoiceTable"),children:"Go to Orders"})]})})}):e.jsx(C,{children:e.jsx(o,{xs:12,children:e.jsxs(K,{className:"mb-4",children:[e.jsx(ve,{children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("strong",{children:"Create Proforma Invoice"}),e.jsxs(p,{color:"secondary",size:"sm",onClick:()=>T("/invoiceTable"),children:[e.jsx(_,{icon:_e,className:"me-1"}),"Back to Orders"]})]})}),e.jsxs(Y,{children:[e.jsxs("div",{className:"bg-light p-3 rounded mb-4",children:[e.jsx("h6",{className:"mb-2",children:"Work Order Information"}),e.jsxs(C,{children:[e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Work Order :"}),e.jsx("div",{children:e.jsx("strong",{children:m.invoice_number})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Project:"}),e.jsx("div",{children:e.jsx("strong",{children:(U=m.project)==null?void 0:U.project_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Customer:"}),e.jsx("div",{children:e.jsx("strong",{children:(X=m.project)==null?void 0:X.customer_name})})]}),e.jsxs(o,{md:3,children:[e.jsx("small",{className:"text-muted",children:"Location:"}),e.jsx("div",{children:(J=m.project)==null?void 0:J.work_place})]})]})]}),e.jsxs(ke,{validated:re,onSubmit:ue,children:[e.jsxs(C,{className:"mb-3",children:[e.jsxs(o,{md:4,children:[e.jsx(h,{children:"Tally Invoice Number"}),e.jsx(c,{type:"text",name:"tally_invoice_number",value:n.tally_invoice_number,onChange:f,placeholder:"Optional - Enter Tally invoice "})]}),e.jsxs(o,{md:4,children:[e.jsx(h,{children:"Invoice Date *"}),e.jsx(c,{type:"date",name:"invoice_date",value:n.invoice_date,onChange:f,required:!0})]}),e.jsxs(o,{md:4,children:[e.jsx(h,{children:"Delivery Date"}),e.jsx(c,{type:"date",name:"delivery_date",value:n.delivery_date,onChange:f})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Work Details"}),y.map((r,t)=>e.jsxs(C,{className:"g-3 mb-3 align-items-center",children:[e.jsx(o,{md:2,children:e.jsx(c,{placeholder:"Work Type",value:r.work_type,onChange:s=>A(t,"work_type",s.target.value),required:!0})}),e.jsx(o,{md:2,children:e.jsx(c,{placeholder:"Unit of Measurerment",value:r.uom,onChange:s=>A(t,"uom",s.target.value),required:!0})}),e.jsx(o,{md:2,children:e.jsx(c,{type:"number",placeholder:"Quantity",value:r.qty,onChange:s=>A(t,"qty",parseFloat(s.target.value)||0),min:"0",required:!0})}),e.jsx(o,{md:2,children:e.jsxs(g,{children:[e.jsx(b,{children:"₹"}),e.jsx(c,{type:"number",placeholder:"Price",value:r.price,onChange:s=>A(t,"price",parseFloat(s.target.value)||0),min:"0",step:"0.01",required:!0})]})}),e.jsx(o,{md:1,children:e.jsxs("span",{className:"text-success fw-medium",children:["₹",r.total_price.toFixed(2)]})}),e.jsx(o,{md:2,children:e.jsx(c,{placeholder:"Remark",value:r.remark,onChange:s=>A(t,"remark",s.target.value)})}),e.jsx(o,{md:1,children:e.jsx(p,{color:"danger",size:"sm",onClick:()=>me(t),disabled:y.length===1,children:"×"})})]},t)),e.jsx(p,{color:"warning",variant:"outline",className:"mb-4",onClick:de,children:"+ Add Work"}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"GST Details"}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(h,{children:"Total GST (%)"}),e.jsxs(g,{children:[e.jsx(c,{type:"number",name:"gstPercentage",value:n.gstPercentage,onChange:f,min:"0",max:"100",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",n.gstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"SGST (%)"}),e.jsxs(g,{children:[e.jsx(c,{type:"number",name:"sgstPercentage",value:n.sgstPercentage,onChange:f,min:"0",max:"50",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",n.sgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"CGST (%)"}),e.jsxs(g,{children:[e.jsx(c,{type:"number",name:"cgstPercentage",value:n.cgstPercentage,onChange:f,min:"0",max:"50",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",n.cgstAmount.toFixed(2)]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"IGST (%)"}),e.jsxs(g,{children:[e.jsx(c,{type:"number",name:"igstPercentage",value:n.igstPercentage,onChange:f,min:"0",max:"100",step:"0.01"}),e.jsx(b,{children:"%"})]}),e.jsxs("small",{className:"text-muted",children:["Amount: ₹",n.igstAmount.toFixed(2)]})]})]}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(o,{md:3,children:[e.jsx(h,{children:"Subtotal"}),e.jsxs(g,{children:[e.jsx(b,{children:"₹"}),e.jsx(c,{type:"number",value:n.subtotal.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"Discount"}),e.jsxs(g,{children:[e.jsx(b,{children:"₹"}),e.jsx(c,{type:"number",name:"discount",value:n.discount,onChange:f,min:"0",step:"0.01"})]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"Taxable Amount"}),e.jsxs(g,{children:[e.jsx(b,{children:"₹"}),e.jsx(c,{type:"number",value:n.taxableAmount.toFixed(2),readOnly:!0})]})]}),e.jsxs(o,{md:3,children:[e.jsx(h,{children:"Final Amount"}),e.jsxs(g,{children:[e.jsx(b,{children:"₹"}),e.jsx(c,{type:"number",value:n.finalAmount.toFixed(2),readOnly:!0,className:"fw-bold"})]})]})]}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Payment Terms"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:P.map((r,t)=>ie===t?e.jsxs(g,{style:{width:"auto"},children:[e.jsx(c,{value:M,onChange:s=>V(s.target.value)}),e.jsx(p,{color:"success",onClick:()=>{const s=[...P];s[t]=M,q(s),I(-1)},children:"Save"}),e.jsx(p,{color:"secondary",onClick:()=>I(-1),children:"Cancel"})]},t):e.jsxs(Z,{color:"info",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[r,e.jsx(_,{icon:ee,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{I(t),V(r)}}),e.jsx(_,{icon:te,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{q(P.filter((s,a)=>a!==t))}})]},t))}),e.jsx(C,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(g,{children:[e.jsx(c,{placeholder:"Add new payment term...",value:W,onChange:r=>$(r.target.value)}),e.jsx(p,{color:"primary",onClick:()=>{W.trim()&&(q([...P,W.trim()]),$(""))},children:"Add"})]})})}),e.jsx("h6",{className:"mt-4 mb-3 fw-semibold text-primary border-bottom border-primary pb-2",children:"Terms & Conditions"}),e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:w.map((r,t)=>le===t?e.jsxs(g,{style:{width:"auto"},children:[e.jsx(c,{value:B,onChange:s=>H(s.target.value)}),e.jsx(p,{color:"success",onClick:()=>{const s=[...w];s[t]=B,E(s),O(-1)},children:"Save"}),e.jsx(p,{color:"secondary",onClick:()=>O(-1),children:"Cancel"})]},t):e.jsxs(Z,{color:"warning",className:"me-1 mb-1",style:{fontSize:"0.9em"},children:[r,e.jsx(_,{icon:ee,className:"ms-2",style:{cursor:"pointer"},onClick:()=>{O(t),H(r)}}),e.jsx(_,{icon:te,className:"ms-1",style:{cursor:"pointer"},onClick:()=>{E(w.filter((s,a)=>a!==t))}})]},t))}),e.jsx(C,{className:"mb-3",children:e.jsx(o,{md:6,children:e.jsxs(g,{children:[e.jsx(c,{placeholder:"Add new condition...",value:R,onChange:r=>Q(r.target.value)}),e.jsx(p,{color:"primary",onClick:()=>{R.trim()&&(E([...w,R.trim()]),Q(""))},children:"Add"})]})})}),e.jsx(C,{className:"mb-3",children:e.jsxs(o,{md:12,children:[e.jsx(h,{children:"Additional Notes"}),e.jsx(Pe,{name:"notes",value:n.notes,onChange:f,rows:3,placeholder:"Enter any additional notes or instructions..."})]})}),e.jsxs(p,{color:"primary",type:"submit",disabled:L,children:[L?e.jsx(fe,{size:"sm"}):e.jsx(_,{icon:we,className:"me-1"}),"Create Proforma Invoice"]})]})]})]})})})};export{Ue as default};
